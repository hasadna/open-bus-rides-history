<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>מעקב מספר קווים - לוח נסיעות רטרואקטיבי</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <style>
    #mapContainer{
      min-height: 250px;
    }
    .sortable {
      cursor: pointer;
    }
    .sortable:hover {
      background-color: #f3f4f6;
    }
    .sort-indicator {
      margin-right: 5px;
    }
    .vehicle-group-border {
      border-top: 3px solid #2563eb !important;
      background-color: #eff6ff;
    }
  </style>
</head>
<body class="bg-gray-50 p-6 text-gray-800">

  <div class="max-w-6xl mx-auto bg-white p-6 rounded-2xl shadow-md space-y-4">
    <h1 class="text-2xl font-bold text-center mb-6">מעקב מספר קווים - לוח נסיעות רטרואקטיבי</h1>

    <!-- בחירת תאריך -->
    <div class="bg-blue-50 p-4 rounded-lg">
      <div class="space-y-2">
        <label class="block font-medium" for="selectedDate">תאריך לבדיקה:</label>
        <input id="selectedDate" type="date" class="w-full rounded-xl border border-gray-300 p-2" value="2025-05-18">
      </div>
    </div>

    <!-- רשימת קווים -->
    <div class="bg-gray-50 p-4 rounded-lg">
      <h2 class="text-lg font-bold mb-4">רשימת קווים לבדיקה</h2>
      
      <div id="linesList" class="space-y-3 mb-4">
        <!-- כאן יתווספו הקווים שנבחרו -->
      </div>

      <!-- הוספת קו חדש -->
      <div class="border-2 border-dashed border-gray-300 p-4 rounded-lg">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
          <div class="space-y-2">
            <label class="block font-medium" for="newOperatorSelect">בחר מפעיל:</label>
            <select id="newOperatorSelect" class="w-full rounded-xl border border-gray-300 p-2">
              <option value="">טוען...</option>
            </select>
          </div>
          
          <div class="space-y-2">
            <label class="block font-medium" for="newRouteNumber">מספר קו (1-999):</label>
            <input id="newRouteNumber" type="number" min="1" max="999" placeholder="לדוגמה: 402" class="w-full rounded-xl border border-gray-300 p-2">
          </div>
          
          <button onclick="addNewLine()" class="bg-green-600 text-white p-2 rounded-xl hover:bg-green-700 transition flex items-center justify-center">
            <span class="text-xl mr-2">+</span> הוסף קו
          </button>
          
          <button onclick="loadAllOperatorRoutes()" class="bg-purple-600 text-white p-2 rounded-xl hover:bg-purple-700 transition flex items-center justify-center">
            <span class="text-xl mr-2">📋</span> טען כל קווי המפעיל
          </button>
        </div>
        
        <!-- ייבוא CSV -->
        <div class="mt-4 pt-4 border-t border-gray-200">
          <div class="flex items-center gap-3">
            <label for="csvFile" class="bg-blue-600 text-white px-4 py-2 rounded-xl hover:bg-blue-700 transition cursor-pointer">
              📁 ייבוא מ-CSV
            </label>
            <input type="file" id="csvFile" accept=".csv" class="hidden" onchange="importFromCSV(event)">
            <span class="text-sm text-gray-600">פורמט: מספר קו,חברה</span>
            <button onclick="clearAllLines()" class="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition text-sm">
              🗑️ נקה הכל
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- כפתורי פעולה -->
    <div class="flex space-x-3 rtl:space-x-reverse">
      <button onclick="loadAllRides()" class="bg-blue-600 text-white px-6 py-2 rounded-xl hover:bg-blue-700 transition">
        טען את כל הנסיעות
      </button>
      <button onclick="clearResults()" class="bg-gray-500 text-white px-6 py-2 rounded-xl hover:bg-gray-600 transition">
        נקה תוצאות
      </button>
    </div>

    <!-- תוצאות -->
    <div id="results" class="mt-6"></div>
    
    <!-- אינדיקטור טעינה -->
    <div id="loadingIndicator" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full">
        <p class="text-blue-600 text-center">טוען נתונים...</p>
        <div id="progressText" class="text-gray-600 text-center mt-2">מכין לטעינה...</div>
      </div>
    </div>
  </div>

  <script>
  let selectedLines = [];
  let allRides = [];
  let currentSortField = 'scheduled_start_time';
  let currentSortDirection = 'asc';

  // טעינת מפעילים בטעינת הדף
  document.addEventListener("DOMContentLoaded", () => {
    loadOperators();
    document.getElementById("selectedDate").addEventListener("change", loadOperators);
  });

  // פונקציה לטעינת מפעילים
  async function loadOperators() {
    const selectedDate = document.getElementById("selectedDate").value;
    
    try {
      const res = await fetch(`https://open-bus-stride-api.hasadna.org.il/gtfs_agencies/list?limit=100&date_from=${selectedDate}&date_to=${selectedDate}`);
      let data = await res.json();
      
      // אם התקבל מערך ריק, השתמש ברשימה דיפולטיבית
      if (!data || data.length === 0) {
        data = [{"date":"2025-05-01","operator_ref":3,"agency_name":"אגד"},{"date":"2025-05-01","operator_ref":25,"agency_name":"אלקטרה אפיקים"},{"date":"2025-05-01","operator_ref":4,"agency_name":"אלקטרה אפיקים תחבורה"},{"date":"2025-05-01","operator_ref":37,"agency_name":"אקסטרה"},{"date":"2025-05-01","operator_ref":38,"agency_name":"אקסטרה ירושלים"},{"date":"2025-05-01","operator_ref":35,"agency_name":"בית שמש אקספרס"},{"date":"2025-05-01","operator_ref":8,"agency_name":"גי.בי.טורס"},{"date":"2025-05-01","operator_ref":23,"agency_name":"גלים"},{"date":"2025-05-01","operator_ref":5,"agency_name":"דן"},{"date":"2025-05-01","operator_ref":32,"agency_name":"דן באר שבע"},{"date":"2025-05-01","operator_ref":31,"agency_name":"דן בדרום"},{"date":"2025-05-01","operator_ref":135,"agency_name":"דרך אגד עוטף ירושלים"},{"date":"2025-05-01","operator_ref":44,"agency_name":"ירושלים-אבו-תור-ענאתא איחוד"},{"date":"2025-05-01","operator_ref":45,"agency_name":"ירושלים-אלווסט איחוד"},{"date":"2025-05-01","operator_ref":50,"agency_name":"ירושלים-דרום איחוד"},{"date":"2025-05-01","operator_ref":47,"agency_name":"ירושלים-הר הזיתים"},{"date":"2025-05-01","operator_ref":49,"agency_name":"ירושלים - עיסאוויה מחנה שעפאט איחוד"},{"date":"2025-05-01","operator_ref":51,"agency_name":"ירושלים-צור באהר איחוד"},{"date":"2025-05-01","operator_ref":42,"agency_name":"ירושלים-רמאללה איחוד"},{"date":"2025-05-01","operator_ref":33,"agency_name":"כבל אקספרס"},{"date":"2025-05-01","operator_ref":21,"agency_name":"כפיר"},{"date":"2025-05-01","operator_ref":20,"agency_name":"כרמלית"},{"date":"2025-05-01","operator_ref":91,"agency_name":"מוניות מטרו קו"},{"date":"2025-05-01","operator_ref":10,"agency_name":"מועצה אזורית אילות"},{"date":"2025-05-01","operator_ref":24,"agency_name":"מועצה אזורית גולן"},{"date":"2025-05-01","operator_ref":15,"agency_name":"מטרופולין"},{"date":"2025-05-01","operator_ref":7,"agency_name":"נסיעות ותיירות"},{"date":"2025-05-01","operator_ref":14,"agency_name":"נתיב אקספרס"},{"date":"2025-05-01","operator_ref":16,"agency_name":"סופרבוס"},{"date":"2025-05-01","operator_ref":18,"agency_name":"קווים"},{"date":"2025-05-01","operator_ref":2,"agency_name":"רכבת ישראל"},{"date":"2025-05-01","operator_ref":6,"agency_name":"ש.א.מ"},{"date":"2025-05-01","operator_ref":22,"agency_name":"תבל"},{"date":"2025-05-01","operator_ref":34,"agency_name":"תנופה"}];
      }
      
      // הסרת כפילויות לפי operator_ref
      const uniqueOperators = new Map();
      data.forEach(op => {
        if (!uniqueOperators.has(op.operator_ref)) {
          uniqueOperators.set(op.operator_ref, op);
        }
      });
      
      const select = document.getElementById("newOperatorSelect");
      select.innerHTML = '<option value="">בחר מפעיל</option>';
      
      // ממיינים לפי שם המפעיל
      Array.from(uniqueOperators.values())
        .sort((a, b) => a.agency_name.localeCompare(b.agency_name, 'he'))
        .forEach(op => {
          const option = document.createElement("option");
          option.value = op.operator_ref;
          option.textContent = op.agency_name;
          option.setAttribute('data-name', op.agency_name);
          select.appendChild(option);
        });
    } catch (error) {
      console.error("שגיאה בטעינת רשימת המפעילים:", error);
    }
  }

  // פונקציה להוספת קו חדש
  // פונקציה להוספת קו חדש - עם בחירת חלופות
  async function addNewLine() {
    const operatorSelect = document.getElementById("newOperatorSelect");
    const routeNumber = document.getElementById("newRouteNumber").value.trim();
    
    if (!operatorSelect.value || !routeNumber) {
      alert("נא למלא את כל השדות");
      return;
    }
    
    const operatorRef = operatorSelect.value;
    const operatorName = operatorSelect.options[operatorSelect.selectedIndex].getAttribute('data-name');
    const selectedDate = document.getElementById("selectedDate").value;
    
    try {
      // קבלת חלופות הקו
      const routesUrl = `https://open-bus-stride-api.hasadna.org.il/gtfs_routes/list?operator_refs=${operatorRef}&route_short_name=${routeNumber}&date_from=${selectedDate}&date_to=${selectedDate}`;
      const routesRes = await fetch(routesUrl);
      const routesData = await routesRes.json();
      
      if (routesData.length === 0) {
        alert(`לא נמצא קו ${routeNumber} עבור ${operatorName} בתאריך ${selectedDate}`);
        return;
      }
      
      // קיבוץ לפי route_mkt
      const routeGroups = new Map();
      routesData.forEach(route => {
        const routeMkt = route.route_mkt;
        if (!routeGroups.has(routeMkt)) {
          routeGroups.set(routeMkt, []);
        }
        routeGroups.get(routeMkt).push(route);
      });
      
      // אם יש רק חלופה אחת - הוסף ישירות
      if (routeGroups.size === 1) {
        const [routeMkt] = routeGroups.keys();
        const existingLine = selectedLines.find(line => 
          line.operatorRef === operatorRef && line.routeMkt === routeMkt
        );
        
        if (existingLine) {
          alert("קו זה כבר נמצא ברשימה");
          return;
        }
        
        const firstRoute = routeGroups.get(routeMkt)[0];
        const newLine = {
          id: Date.now(),
          operatorRef: operatorRef,
          operatorName: operatorName,
          routeNumber: routeNumber,
          routeMkt: routeMkt,
          displayName: `קו ${routeNumber} - ${extractCityNames(firstRoute.route_long_name)}`
        };
        
        selectedLines.push(newLine);
        updateLinesDisplay();
        document.getElementById("newRouteNumber").value = '';
        return;
      }
      
      // אם יש מספר חלופות - הצג דיאלוג בחירה
      showRouteVariantsDialog(operatorRef, operatorName, routeNumber, routeGroups);
      
    } catch (error) {
      console.error("שגיאה בטעינת חלופות הקו:", error);
      alert(`שגיאה בטעינת חלופות הקו: ${error.message}`);
    }
  }

  // פונקציה לחילוץ שמות ערים מתיאור המסלול
function extractCityNames(routeLongName) {
  try {
    // חילוץ מוצא ויעד מהפורמט: "מוצא-עיר<->יעד-עיר-XX"
    const match = routeLongName.match(/^(.+?)-([^<]+)<->(.+?)-([^-]+)/);
    if (match) {
      const fromCity = match[2].trim();
      const toCity = match[4].trim();
      return `${fromCity} ↔ ${toCity}`;
    }
    return routeLongName.substring(0, 50) + "...";
  } catch (error) {
    return "מסלול לא זמין";
  }
}

// פונקציה להצגת דיאלוג בחירת חלופות
function showRouteVariantsDialog(operatorRef, operatorName, routeNumber, routeGroups) {
  const dialog = document.createElement('div');
  dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
  dialog.setAttribute('data-dialog', 'route-variants');
  
  let variantsHTML = '';
  routeGroups.forEach((routes, routeMkt) => {
    const firstRoute = routes[0];
    const cityNames = extractCityNames(firstRoute.route_long_name);
    const isAlreadySelected = selectedLines.find(line => 
      line.operatorRef === operatorRef && line.routeMkt === routeMkt
    );
    
    variantsHTML += `
      <div class="border rounded-lg p-3 ${isAlreadySelected ? 'bg-gray-100 opacity-50' : 'bg-white hover:bg-blue-50 cursor-pointer'}" 
           ${!isAlreadySelected ? `onclick="selectRouteVariant('${operatorRef}', '${operatorName}', '${routeNumber}', '${routeMkt}', '${cityNames}')"` : ''}>
        <div class="font-bold">קו ${routeNumber} - ${cityNames}</div>
        <div class="text-sm text-gray-600">${routes.length} כיוונים</div>
        ${isAlreadySelected ? '<div class="text-xs text-red-600">כבר נבחר</div>' : ''}
      </div>
    `;
  });
  
  dialog.innerHTML = `
    <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold">בחר חלופת קו ${routeNumber}</h3>
        <button onclick="this.closest('[data-dialog=\"route-variants\"]').remove()" class="text-gray-500 hover:text-gray-800">×</button>
      </div>
      <div class="space-y-2 max-h-60 overflow-y-auto">
        ${variantsHTML}
      </div>
      <div class="mt-4 text-sm text-gray-600">
        * ניתן לבחור מספר חלופות של אותו קו
      </div>
    </div>
  `;
  
  document.body.appendChild(dialog);
}

// פונקציה לבחירת חלופת קו
function selectRouteVariant(operatorRef, operatorName, routeNumber, routeMkt, displayName) {
  const newLine = {
    id: Date.now(),
    operatorRef: operatorRef,
    operatorName: operatorName,
    routeNumber: routeNumber,
    routeMkt: routeMkt,
    displayName: `קו ${routeNumber} - ${displayName}`
  };
  
  selectedLines.push(newLine);
  updateLinesDisplay();
  document.getElementById("newRouteNumber").value = '';
  
  // *** תיקון: חיפוש ספציפי יותר ***
  const routeDialog = event.target.closest('.fixed[data-dialog="route-variants"]');
  if (routeDialog) {
    routeDialog.remove();
  }
}

  // פונקציה לעדכון תצוגת הקווים
  function updateLinesDisplay() {
    const container = document.getElementById("linesList");
    
    if (selectedLines.length === 0) {
      container.innerHTML = '<p class="text-gray-500 text-center">לא נבחרו קווים עדיין</p>';
      return;
    }
    
    container.innerHTML = `
      <div class="flex flex-wrap gap-2">
        ${selectedLines.map(line => `
          <div class="flex items-center bg-white px-3 py-2 rounded-lg border min-w-fit">
            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full font-bold text-sm">${line.displayName || `קו ${line.routeNumber}`}</span>
            <span class="text-gray-700 text-sm mx-2">${line.operatorName}</span>
            <button onclick="removeLine(${line.id})" class="text-red-500 hover:text-red-700 font-bold text-lg">×</button>
          </div>
        `).join('')}
      </div>
    `;
  }

  // פונקציה להסרת קו
  function removeLine(lineId) {
    selectedLines = selectedLines.filter(line => line.id !== lineId);
    updateLinesDisplay();
  }

  // *** התיקון העיקרי כאן ***
  // פונקציה לטעינת כל הנסיעות - פופאפ נסגר רק בסוף הרינדור
  async function loadAllRides() {
    if (selectedLines.length === 0) {
      alert("נא להוסיף לפחות קו אחד לבדיקה");
      return;
    }
    
    const selectedDate = document.getElementById("selectedDate").value;
    if (!selectedDate) {
      alert("נא לבחור תאריך");
      return;
    }
    
    showLoading(true);
    updateProgress("מכין לטעינה...");
    
    allRides = [];
    let totalLines = selectedLines.length;
    
    try {
      for (let i = 0; i < selectedLines.length; i++) {
        const line = selectedLines[i];
        updateProgress(`טוען קו ${line.routeNumber} של ${line.operatorName} (${i + 1}/${totalLines})`);
        
        const rides = await loadRidesForLine(line, selectedDate);
        allRides = [...allRides, ...rides];
      }
      
      // מיון לפי שעת יציאה
      allRides.sort((a, b) => a.scheduled_start_time - b.scheduled_start_time);
      
      // הפופאפ ממשיך להיות פתוח וייסגר רק בסוף displayResults
      displayResults();
      
    } catch (error) {
      console.error("שגיאה בטעינת הנסיעות:", error);
      alert(`שגיאה בטעינת הנסיעות: ${error.message}`);
      showLoading(false); // סגירת פופאפ רק במקרה של שגיאה
    }
    // הסרנו את finally - הפופאפ ייסגר רק אחרי גמר הרינדור המלא
  }

  // פונקציה לטעינת נסיעות עבור קו ספציפי
  async function loadRidesForLine(line, selectedDate) {
    try {
      // טעינת חלופות הקו
      const routesUrl = line.routeMkt 
  ? `https://open-bus-stride-api.hasadna.org.il/gtfs_routes/list?operator_refs=${line.operatorRef}&route_mkt=${line.routeMkt}&date_from=${selectedDate}&date_to=${selectedDate}`
  : `https://open-bus-stride-api.hasadna.org.il/gtfs_routes/list?operator_refs=${line.operatorRef}&route_short_name=${line.routeNumber}&date_from=${selectedDate}&date_to=${selectedDate}`;
      const routesRes = await fetch(routesUrl);
      const routesData = await routesRes.json();
      
      if (routesData.length === 0) {
        console.log(`לא נמצאו חלופות עבור קו ${line.routeNumber} של ${line.operatorName}`);
        return [];
      }
      
      // איחוד לפי line_ref
      const uniqueRoutes = new Map();
      routesData.forEach(route => {
        if (!uniqueRoutes.has(route.line_ref)) {
          uniqueRoutes.set(route.line_ref, route);
        }
      });
      
      const lineRefs = Array.from(uniqueRoutes.keys()).join(',');
      
      // טעינת נסיעות
      const startTime = new Date(`${selectedDate}T00:00:00`).getTime();
      const endTime = new Date(`${selectedDate}T23:59:59`).getTime();
      
      // קבלת ספירת התוצאות תחילה
      const countUrl = `https://open-bus-stride-api.hasadna.org.il/siri_rides/list?get_count=1&scheduled_start_time_from=${startTime}&scheduled_start_time_to=${endTime}&siri_route__line_refs=${lineRefs}`;
      const countResponse = await fetch(countUrl);
      const totalCount = parseInt(await countResponse.text(), 10);
      
      if (totalCount === 0) {
        return [];
      }
      
      // טעינת כל הנסיעות
      let rides = [];
      const batchSize = 100;
      const batchCount = Math.ceil(totalCount / batchSize);
      
      for (let batchIndex = 0; batchIndex < batchCount; batchIndex++) {
        const offset = batchIndex * batchSize;
        const batchUrl = `https://open-bus-stride-api.hasadna.org.il/siri_rides/list?scheduled_start_time_from=${startTime}&scheduled_start_time_to=${endTime}&siri_route__line_refs=${lineRefs}&limit=${batchSize}&offset=${offset}`;
        const batchResponse = await fetch(batchUrl);
        const batchData = await batchResponse.json();
        rides = [...rides, ...batchData];
      }
      
      // הוספת מידע על הקו והמפעיל לכל נסיעה
      rides.forEach(ride => {
        ride.line_number = line.routeNumber;
        ride.operator_name = line.operatorName;
        ride.operator_ref = line.operatorRef;
        ride.route_mkt = line.routeMkt; // *** הוספת route_mkt לנתוני הנסיעה ***
        
        // מציאת החלופה המתאימה
        const routeVariant = Array.from(uniqueRoutes.values()).find(route => route.line_ref === ride.siri_route__line_ref);
        if (routeVariant) {
          try {
            // פיצול לפי <-> ואז מציאת המינוס האחרון
            const parts = routeVariant.route_long_name.split('<->');
            if (parts.length === 2) {
              const lastDashIndex = parts[1].lastIndexOf('-');
              ride.route_dest = {
                from: parts[0].trim(),
                to: lastDashIndex !== -1 ? parts[1].substring(0, lastDashIndex).trim() : parts[1].trim(),
                alternative: lastDashIndex !== -1 ? parts[1].substring(lastDashIndex + 1).trim() : '',
              };
            } else {
              ride.route_dest = { from: routeVariant.route_long_name, to: '', alternative: '' };
            }
          } catch (error) {
            ride.route_dest = { from: '', to: '', alternative: '' };
          }
        }
      });
      
      return rides;
      
    } catch (error) {
      console.error(`שגיאה בטעינת נתונים עבור קו ${line.routeNumber}:`, error);
      return [];
    }
  }

  // פונקציה לטעינת כל קווי המפעיל
  async function loadAllOperatorRoutes() {
    const operatorSelect = document.getElementById("newOperatorSelect");
    
    if (!operatorSelect.value) {
      alert("נא לבחור מפעיל תחילה");
      return;
    }
    
    const operatorRef = operatorSelect.value;
    const operatorName = operatorSelect.options[operatorSelect.selectedIndex].getAttribute('data-name');
    const selectedDate = document.getElementById("selectedDate").value;
    
    if (!selectedDate) {
      alert("נא לבחור תאריך");
      return;
    }
    
    showLoading(true);
    updateProgress(`טוען את כל קווי ${operatorName}...`);
    
    try {
      // קבלת כל הקווים של המפעיל
      const routesUrl = `https://open-bus-stride-api.hasadna.org.il/gtfs_routes/list?operator_refs=${operatorRef}&date_from=${selectedDate}&date_to=${selectedDate}&limit=-1`;
      const routesRes = await fetch(routesUrl);
      const routesData = await routesRes.json();
      
      if (routesData.length === 0) {
        alert(`לא נמצאו קווים עבור ${operatorName} בתאריך ${selectedDate}`);
        return;
      }
      
      // *** קיבוץ לפי route_mkt במקום route_short_name ***
      const routeGroups = new Map();
      routesData.forEach(route => {
        const routeMkt = route.route_mkt;
        const routeNumber = route.route_short_name;
        
        if (routeMkt && routeNumber) {
          if (!routeGroups.has(routeMkt)) {
            routeGroups.set(routeMkt, {
              routeMkt: routeMkt,
              routeNumber: routeNumber,
              displayName: `קו ${routeNumber} - ${extractCityNames(route.route_long_name)}`,
              routes: []
            });
          }
          routeGroups.get(routeMkt).routes.push(route);
        }
      });
      
      updateProgress(`נמצאו ${routeGroups.size} קווים ייחודיים (לפי route_mkt)...`);
      
      // הוספת הקווים החדשים (מתעלמים מכפילויות שכבר קיימות)
      let addedCount = 0;
      let skippedCount = 0;
      
      routeGroups.forEach((routeGroup, routeMkt) => {
        // *** בדיקה אם הקו כבר קיים לפי route_mkt ***
        const existingLine = selectedLines.find(line => 
          line.operatorRef === operatorRef && line.routeMkt === routeMkt
        );
        
        if (existingLine) {
          skippedCount++;
          return;
        }
        
        // הוספת הקו החדש עם route_mkt
        const newLine = {
          id: Date.now() + Math.random(), // מניעת התנגשות ID
          operatorRef: operatorRef,
          operatorName: operatorName,
          routeNumber: routeGroup.routeNumber,
          routeMkt: routeMkt, // *** הוספת route_mkt ***
          displayName: routeGroup.displayName
        };
        
        selectedLines.push(newLine);
        addedCount++;
      });
      
      // עדכון התצוגה
      updateLinesDisplay();
      
      // הודעה על התוצאות
      let message = `נוספו ${addedCount} קווים חדשים מ${operatorName}`;
      if (skippedCount > 0) {
        message += `\n${skippedCount} קווים כבר היו ברשימה`;
      }
      alert(message);
      
    } catch (error) {
      console.error("שגיאה בטעינת קווי המפעיל:", error);
      alert(`שגיאה בטעינת קווי המפעיל: ${error.message}`);
    } finally {
      showLoading(false);
    }
  }

  // פונקציה למיון הטבלה
  function sortTable(field) {
    if (currentSortField === field) {
      currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
      currentSortField = field;
      currentSortDirection = 'asc';
    }
    
    allRides.sort((a, b) => {
      let aVal = a[field];
      let bVal = b[field];
      
      // טיפול בערכים ריקים
      if (!aVal && !bVal) return 0;
      if (!aVal) return 1;
      if (!bVal) return -1;
      
      // מיון מיוחד לפי מספר רישוי + שעת יציאה לזיהוי נסיעות צמודות
      if (field === 'vehicle_ref') {
        // מיון ראשוני לפי מספר רישוי
        if (aVal !== bVal) {
          const comparison = aVal.localeCompare(bVal);
          return currentSortDirection === 'asc' ? comparison : -comparison;
        }
        // אם מספר הרישוי זהה, מיון לפי שעת יציאה
        const aTime = new Date(a.scheduled_start_time);
        const bTime = new Date(b.scheduled_start_time);
        return currentSortDirection === 'asc' ? aTime - bTime : bTime - aTime;
      }
      
      // טיפול בערכי זמן
      if (field === 'scheduled_start_time') {
        aVal = new Date(aVal);
        bVal = new Date(bVal);
      }
      
      // טיפול במספרים
      if (field === 'line_number') {
        aVal = parseInt(aVal) || 0;
        bVal = parseInt(bVal) || 0;
      }
      
      // השוואה
      if (aVal < bVal) return currentSortDirection === 'asc' ? -1 : 1;
      if (aVal > bVal) return currentSortDirection === 'asc' ? 1 : -1;
      return 0;
    });
    
    displayResults();
  }

  // פונקציה להצגת אינדיקטור מיון
  function getSortIndicator(field) {
    if (currentSortField !== field) return '↕️';
    return currentSortDirection === 'asc' ? '⬆️' : '⬇️';
  }

  // פונקציה לייבוא קווים מ-CSV
  async function importFromCSV(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    try {
      const text = await file.text();
      const lines = text.trim().split('\n');
      
      // בדיקה אם השורה הראשונה היא כותרת
      const firstLine = lines[0].toLowerCase();
      const hasHeader = firstLine.includes('מספר') || firstLine.includes('חברה') || firstLine.includes('קו');
      const dataLines = hasHeader ? lines.slice(1) : lines;
      
      let importedCount = 0;
      let skippedCount = 0;
      
      for (const line of dataLines) {
        if (!line.trim()) continue;
        
        const [routeNumber, operatorName] = line.split(',').map(s => s.trim());
        
        if (!routeNumber || !operatorName) {
          console.warn(`שורה לא תקינה: ${line}`);
          skippedCount++;
          continue;
        }
        
        // חיפוש המפעיל ברשימה
        const operatorSelect = document.getElementById("newOperatorSelect");
        let operatorRef = null;
        
        for (let i = 0; i < operatorSelect.options.length; i++) {
          const option = operatorSelect.options[i];
          const optionName = option.getAttribute('data-name');
          if (optionName && optionName.includes(operatorName)) {
            operatorRef = option.value;
            break;
          }
        }
        
        if (!operatorRef) {
          console.warn(`מפעיל לא נמצא: ${operatorName}`);
          skippedCount++;
          continue;
        }
        
        // בדיקה אם הקו כבר קיים
        const existingLine = selectedLines.find(line => 
          line.operatorRef === operatorRef && line.routeNumber === routeNumber
        );
        
        if (existingLine) {
          skippedCount++;
          continue;
        }
        
        // הוספת הקו
        const newLine = {
          id: Date.now() + Math.random(), // מניעת התנגשות ID
          operatorRef: operatorRef,
          operatorName: operatorName,
          routeNumber: routeNumber
        };
        
        selectedLines.push(newLine);
        importedCount++;
      }
      
      updateLinesDisplay();
      
      // הודעה על התוצאות
      let message = `יובאו ${importedCount} קווים בהצלחה`;
      if (skippedCount > 0) {
        message += `\n${skippedCount} קווים דולגו (כפילויות או שגיאות)`;
      }
      alert(message);
      
    } catch (error) {
      console.error("שגיאה בייבוא CSV:", error);
      alert(`שגיאה בייבוא הקובץ: ${error.message}`);
    }
    
    // איפוס שדה הקובץ
    event.target.value = '';
  }

  // פונקציה לניקוי כל הקווים
  function clearAllLines() {
    if (selectedLines.length === 0) {
      alert("אין קווים לניקוי");
      return;
    }
    
    if (confirm(`האם אתה בטוח שברצונך למחוק את כל ${selectedLines.length} הקווים?`)) {
      selectedLines = [];
      updateLinesDisplay();
      clearResults();
    }
  }

  // פונקציה לניקוי תוצאות
  function clearResults() {
    document.getElementById("results").innerHTML = '';
    allRides = [];
  }
  
  function showLoading(show) {
    const loadingIndicator = document.getElementById('loadingIndicator');
    if (!loadingIndicator) {
      console.error('Loading indicator not found!');
      return;
    }
    
    if (show) {
      loadingIndicator.classList.remove('hidden');
    } else {
      loadingIndicator.classList.add('hidden');
    }
  }

  // פונקציה לעדכון הודעת ההתקדמות
  function updateProgress(message) {
    const progressText = document.getElementById('progressText');
    if (progressText) {
      progressText.textContent = message;
    }
  }

  // פונקציה להצגת מפה (מהקובץ המקורי)
  async function showRideMap(siriRideId, gtfsRouteId) {
    if (!siriRideId) {
      alert("אין נתוני מסלול זמינים לנסיעה זו");
      return;
    }
    
    showLoading(true);
    updateProgress("טוען נתוני מיקום...");
    
    try {
      // יצירת דיאלוג להצגת המפה
      const mapDialog = document.createElement('div');
      mapDialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      mapDialog.setAttribute('data-dialog', 'map');
      mapDialog.innerHTML = `
        <div class="bg-white rounded-xl p-6 max-w-5xl w-full h-4/5 flex flex-col">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">מפת נסיעה</h2>
            <button id="closeMapBtn" class="text-gray-500 hover:text-gray-800">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          <div id="mapContainer" class="flex-grow bg-gray-100 rounded-lg">
            <div class="w-full h-full flex items-center justify-center">
              <p class="text-blue-600">טוען נתוני מיקום...</p>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(mapDialog);
      
      // הגדרת כפתור סגירה
      document.getElementById('closeMapBtn').addEventListener('click', () => {
        document.body.removeChild(mapDialog);
      });
      
      // קבלת נתוני המיקום GPS
      const locationData = await fetchLocationData(siriRideId);
      
      if (locationData.length === 0) {
        document.getElementById('mapContainer').innerHTML = '<p class="text-center p-4">לא נמצאו נתוני מיקום GPS לנסיעה זו</p>';
        showLoading(false);
        return;
      }
      
      renderLocationMap(locationData);
      
    } catch (error) {
      console.error("שגיאה בטעינת נתוני מיקום:", error);
      if (document.getElementById('mapContainer')) {
        document.getElementById('mapContainer').innerHTML = `<p class="text-red-600 p-4 text-center">שגיאה בטעינת נתוני מיקום: ${error.message}</p>`;
      }
    } finally {
      showLoading(false);
    }
  }

  // פונקציה לקבלת נתוני מיקום (מהקובץ המקורי)
  async function fetchLocationData(siriRideId) {
    try {
      const response = await fetch(`https://open-bus-stride-api.hasadna.org.il/siri_vehicle_locations/list?limit=500&siri_rides__ids=${siriRideId}`);
      
      if (!response.ok) {
        console.error(`שגיאת שרת בקבלת נתוני מיקום: ${response.status}`);
        return [];
      }
      
      const data = await response.json();
      
      return data
        .filter(loc => loc.lat && loc.lon)
        .sort((a, b) => new Date(a.recorded_at_time) - new Date(b.recorded_at_time));
        
    } catch (error) {
      console.error("שגיאה בקבלת נתוני מיקום:", error);
      return [];
    }
  }

  // פונקציה לרינדור מפה עם נתוני מיקום GPS (מהקובץ המקורי)
  function renderLocationMap(locationData) {
    if (locationData.length === 0) {
      document.getElementById('mapContainer').innerHTML = '<p class="text-center p-4">לא נמצאו נתוני מיקום לנסיעה זו</p>';
      return;
    }
    
    // תצוגת המיקומים במפה
    const mapContainer = document.getElementById('mapContainer');
    mapContainer.innerHTML = '<div id="map" class="w-full h-full"></div>';
    
    // יצירת מפה באמצעות Leaflet
    const map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    
    // הוספת הנקודות למפה
    const points = locationData.map(loc => [loc.lat, loc.lon]);
      
    // יצירת קו המחבר את הנקודות
    const polyline = L.polyline(points, {color: 'blue', weight: 4}).addTo(map);
      
    // הוספת סמן לכל נקודת GPS עם פופאפ
    locationData.forEach((loc, index) => {
      // יצירת סמן מותאם אישית עבור כל נקודה (כנקודה כהה)
      const pointIcon = L.divIcon({
        html: '<div class="bg-gray-800 rounded-full w-2 h-2 border border-white"></div>',
        className: 'custom-point-icon',
        iconSize: [3, 3],
        iconAnchor: [1, 1]
      });
      
      // יצירת פופאפ עם הזמן המדויק
      const timestamp = new Date(loc.recorded_at_time).toLocaleString('he-IL');
      const popupContent = `
        <div class="text-right">
          <strong>זמן:</strong> ${timestamp}<br>
          <strong>קואורדינטות:</strong> ${loc.lat.toFixed(6)}, ${loc.lon.toFixed(6)}
        </div>
      `;
      
      // הוספת הסמן למפה עם הפופאפ
      L.marker([loc.lat, loc.lon], {icon: pointIcon}).addTo(map)
        .bindPopup(popupContent);
    });
      
    // הוספת סמנים לתחילת וסוף המסלול
    const startIcon = L.divIcon({
      html: '<div class="bg-green-600 rounded-full w-4 h-4 border-2 border-white"></div>',
      className: 'custom-div-icon'
    });
    
    const endIcon = L.divIcon({
      html: '<div class="bg-red-600 rounded-full w-4 h-4 border-2 border-white"></div>',
      className: 'custom-div-icon'
    });
    
    // הוספת סימון לתחילת וסוף המסלול
    L.marker(points[0], {icon: startIcon}).addTo(map)
      .bindPopup(`<strong>תחילת מסלול</strong><br>${new Date(locationData[0].recorded_at_time).toLocaleString('he-IL')}`);
    
    L.marker(points[points.length - 1], {icon: endIcon}).addTo(map)
      .bindPopup(`<strong>סוף מסלול</strong><br>${new Date(locationData[locationData.length - 1].recorded_at_time).toLocaleString('he-IL')}`);
    
    // הוספת סמנים לכל תחנה (אם יש מידע על תחנות)
    locationData.forEach((loc, index) => {
      if (loc.stop_point_ref) {
        const stationIcon = L.divIcon({
          html: '<div class="bg-blue-500 rounded-full w-3 h-3 border border-white"></div>',
          className: 'custom-station-icon'
        });
        
        L.marker([loc.lat, loc.lon], {icon: stationIcon}).addTo(map)
          .bindPopup(`<strong>תחנה: ${loc.stop_point_ref}</strong><br>${new Date(loc.recorded_at_time).toLocaleString('he-IL')}`);
      }
    });
    
    // התאמת התצוגה כך שכל הנקודות יהיו גלויות
    map.fitBounds(polyline.getBounds(), { padding: [30, 30] });
  }

  // ===============

  // ===== מחלקה לניהול ביצועים וחיפוש =====
class RidesTableManager {
  constructor() {
    this.filterTimeout = null;
    this.currentSortField = 'scheduled_start_time';
    this.currentSortDirection = 'asc';
  }

  // 1. פונקציה מאופטמת להצגת תוצאות עם רינדור מדורג
  async displayResultsChunked() {
    const resultsDiv = document.getElementById("results");
    
    if (allRides.length === 0) {
      resultsDiv.innerHTML = '<p class="text-red-600 text-center">לא נמצאו נסיעות בתאריך הנבחר עבור הקווים שנבחרו.</p>';
      return;
    }
    
    // אזהרה למקרים קיצוניים
    if (allRides.length > 10000) {
      const proceed = confirm(`נמצאו ${allRides.length} נסיעות.\n\nזה עלול לגרום לביצועים איטיים מאוד.\nהאם להמשיך?\n\n(מומלץ לסנן לפחות קווים או תאריכים)`);
      if (!proceed) return;
    }
    
    // לא נפתח פופאפ חדש כאן - נמשיך עם הקיים
    updateProgress("מכין את הטבלה...");
    
    // יצירת המבנה הבסיסי
    const searchAndControlsHTML = this.createSearchControls();
    const tableHeaderHTML = this.createTableHeader();
    
    resultsDiv.innerHTML = searchAndControlsHTML + `
      <div class="overflow-x-auto">
        <table id="ridesTable" class="w-full table-auto border border-collapse">
          ${tableHeaderHTML}
          <tbody id="ridesTableBody">
            <!-- שורות יתווספו בהדרגה -->
          </tbody>
        </table>
      </div>
      <div id="loadingRows" class="text-center p-4 text-blue-600">
        טוען נתונים...
      </div>
    `;
    
    // רינדור בחלקים קטנים כדי לא לחסום את הדפדפן
    await this.renderTableInChunks();
    // *** סגירת הפופאפ רק כאן - אחרי גמר הרינדור המלא ***
    showLoading(false);
  }

  // 2. רינדור מדורג
  async renderTableInChunks() {
    const tbody = document.getElementById('ridesTableBody');
    const loadingIndicator = document.getElementById('loadingRows');
    const chunkSize = 100; // 100 שורות בכל פעם
    let currentIndex = 0;
    
    const renderChunk = () => {
      return new Promise((resolve) => {
        const endIndex = Math.min(currentIndex + chunkSize, allRides.length);
        const chunk = allRides.slice(currentIndex, endIndex);
        
        // יצירת HTML עבור החלק הנוכחי
        const chunkHTML = chunk.map((ride, index) => {
          const globalIndex = currentIndex + index;
          return this.createTableRow(ride, globalIndex);
        }).join('');
        
        // הוספה לטבלה
        tbody.insertAdjacentHTML('beforeend', chunkHTML);
        
        currentIndex = endIndex;
        updateProgress(`נטענו ${currentIndex} מתוך ${allRides.length} נסיעות...`);
        
        // אם יש עוד - תמשיך אחרי delay קצר
        if (currentIndex < allRides.length) {
          setTimeout(() => {
            renderChunk().then(resolve);
          }, 5); // 5ms delay כדי לתת לדפדפן לנשום
        } else {
          // סיום - פופאפ יוסר בפונקציה הקוראת
          if (loadingIndicator) loadingIndicator.remove();
          console.log(`סיום רינדור ${allRides.length} שורות`);
          resolve();
        }
      });
    };
    
    await renderChunk();
  }

  // 3. יצירת שורת טבלה מאופטמת
  createTableRow(ride, index) {
    const rideDate = new Date(ride.scheduled_start_time);
    
    const isNewVehicleGroup = index > 0 && 
      ride.vehicle_ref && 
      allRides[index - 1].vehicle_ref && 
      ride.vehicle_ref !== allRides[index - 1].vehicle_ref;
    
    const rowClass = isNewVehicleGroup ? 'hover:bg-gray-50 vehicle-group-border' : 'hover:bg-gray-50';
    
    // HTML מינימלי לביצועים - הוספת route_mkt ו-line_ref לשדות data
    return `<tr class="${rowClass}" 
               data-vehicle="${ride.vehicle_ref || ''}" 
               data-line="${ride.line_number}" 
               data-operator="${ride.operator_name}" 
               data-route-mkt="${ride.route_mkt || ''}" 
               data-line-ref="${ride.siri_route__line_ref || ''}">
      <td class="border p-2">${rideDate.toLocaleDateString('he-IL')} ${rideDate.toLocaleTimeString('he-IL')}</td>
      <td class="border p-2 font-bold">${ride.line_number}</td>
      <td class="border p-2">${ride.operator_name}</td>
      <td class="border p-2 font-mono vehicle-ref">${ride.vehicle_ref || 'לא זמין'}</td>
      <td class="border p-2">${ride.siri_route__line_ref}</td>
      <td class="border p-2">${ride.route_dest?.from || ""}</td>
      <td class="border p-2">${ride.route_dest?.to || ""}</td>
      <td class="border p-2">${ride.route_dest?.alternative || ""}</td>
      <td class="border p-2">${ride.id ? `<button onclick="showRideMap('${ride.id}', '')" class="bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700 transition">צפה במפה</button>` : 'אין נתונים'}</td>
    </tr>`;
  }

  // 4. יצירת controls
  createSearchControls() {
    return `
      <div class="mb-6 space-y-4">
        <div class="p-3 bg-green-50 rounded-lg">
          <p class="text-green-700 font-bold">נמצאו ${allRides.length} נסיעות בתאריך ${document.getElementById("selectedDate").value}</p>
          <p class="text-gray-600">עבור ${selectedLines.length} קווים</p>
        </div>
        
        <div class="bg-blue-50 p-4 rounded-lg space-y-3">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div>
              <label class="block font-medium mb-1">חיפוש מספר רישוי:</label>
              <input type="text" id="vehicleSearch" placeholder="הקלד מספר רישוי..." 
                     class="w-full p-2 border rounded-lg" 
                     oninput="ridesManager.debounceFilter('vehicle', this.value)">
            </div>
            <div>
              <label class="block font-medium mb-1">בחר קו מהרשימה:</label>
              <div class="relative">
                <input type="text" id="lineSearch" placeholder="הקלד מספר קו או שם עיר..." 
                      class="w-full p-2 border rounded-lg" 
                      oninput="ridesManager.showLineDropdown(this.value)"
                      onfocus="ridesManager.showLineDropdown(this.value)"
                      onblur="setTimeout(() => ridesManager.hideLineDropdown(), 200)">
                <div id="lineDropdown" class="hidden absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg max-h-40 overflow-y-auto z-10">
                  <!-- אפשרויות יתווספו כאן -->
                </div>
              </div>
            </div>
            <div>
              <label class="block font-medium mb-1">חיפוש מפעיל:</label>
              <input type="text" id="operatorSearch" placeholder="הקלד שם מפעיל..." 
                     class="w-full p-2 border rounded-lg" 
                     oninput="ridesManager.debounceFilter('operator', this.value)">
            </div>
          </div>
          
          <div class="flex gap-2 flex-wrap">
            <button onclick="ridesManager.clearAllFilters()" class="bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600">
              נקה סינונים
            </button>
            <button onclick="ridesManager.exportToCSV()" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">
              📄 ייצא ל-CSV
            </button>
            <button onclick="ridesManager.groupByVehicleOptimized()" class="bg-purple-600 text-white px-3 py-1 rounded hover:bg-purple-700">
              📊 קבץ לפי רכב
            </button>
          </div>
        </div>
        
        <div id="filterInfo" class="hidden p-2 bg-yellow-50 rounded border border-yellow-200">
          <span id="filterInfoText"></span>
        </div>
      </div>
    `;
  }

  // 5. יצירת header
  createTableHeader() {
    return `
      <thead class="bg-gray-100 sticky top-0">
        <tr>
          <th class="border p-2 sortable" onclick="ridesManager.sortTableOptimized('scheduled_start_time')">
            תאריך ושעת יציאה <span class="sort-indicator">${getSortIndicator('scheduled_start_time')}</span>
          </th>
          <th class="border p-2 sortable" onclick="ridesManager.sortTableOptimized('line_number')">
            מספר קו <span class="sort-indicator">${getSortIndicator('line_number')}</span>
          </th>
          <th class="border p-2 sortable" onclick="ridesManager.sortTableOptimized('operator_name')">
            חברה מפעילה <span class="sort-indicator">${getSortIndicator('operator_name')}</span>
          </th>
          <th class="border p-2 sortable" onclick="ridesManager.sortTableOptimized('vehicle_ref')">
            מספר רישוי <span class="sort-indicator">${getSortIndicator('vehicle_ref')}</span>
          </th>
          <th class="border p-2">line_ref</th>
          <th class="border p-2">מוצא</th>
          <th class="border p-2">יעד</th>
          <th class="border p-2">חלופה</th>
          <th class="border p-2">מפת נסיעה</th>
        </tr>
      </thead>
    `;
  }

  // 6. סינון עם debouncing
  debounceFilter(type, value) {
    clearTimeout(this.filterTimeout);
    this.filterTimeout = setTimeout(() => {
      switch(type) {
        case 'vehicle': this.filterByVehicle(value); break;
        case 'line': this.filterByLine(value); break;
        case 'operator': this.filterByOperator(value); break;
      }
    }, 200); // 200ms אחרי שהמשתמש מפסיק להקליד
  }

  // 7. פונקציות סינון מאופטמות
  filterByVehicle(vehicleNumber) {
    const filterInfo = document.getElementById('filterInfo');
    const filterInfoText = document.getElementById('filterInfoText');
    
    if (!vehicleNumber.trim()) {
      this.showAllRows();
      filterInfo.classList.add('hidden');
      return;
    }
    
    const rows = document.querySelectorAll('#ridesTableBody tr');
    let visibleCount = 0;
    
    // בצע סינון בחלקים קטנים למקרים קיצוניים
    this.processBatchFilter(rows, (row) => {
      const vehicleRef = row.getAttribute('data-vehicle');
      const shouldShow = vehicleRef && vehicleRef.includes(vehicleNumber);
      if (shouldShow) visibleCount++;
      return shouldShow;
    }, () => {
      filterInfo.classList.remove('hidden');
      filterInfoText.textContent = `מוצגות ${visibleCount} נסיעות המכילות "${vehicleNumber}" במספר הרישוי`;
    });
  }

  // *** התיקון לחיפוש מדויק מספר קו ***
  filterByLine(lineNumber) {
    const filterInfo = document.getElementById('filterInfo');
    const filterInfoText = document.getElementById('filterInfoText');
    
    if (!lineNumber.trim()) {
      this.showAllRows();
      filterInfo.classList.add('hidden');
      return;
    }
    
    const rows = document.querySelectorAll('#ridesTableBody tr');
    let visibleCount = 0;
    
    this.processBatchFilter(rows, (row) => {
      const lineRef = row.getAttribute('data-line');
      // *** חיפוש מדויק - השוואה מלאה במקום includes ***
      const shouldShow = lineRef && lineRef === lineNumber;
      if (shouldShow) visibleCount++;
      return shouldShow;
    }, () => {
      filterInfo.classList.remove('hidden');
      filterInfoText.textContent = `מוצגות ${visibleCount} נסיעות של קו ${lineNumber}`;
    });
  }

  filterByOperator(operatorName) {
    const filterInfo = document.getElementById('filterInfo');
    const filterInfoText = document.getElementById('filterInfoText');
    
    if (!operatorName.trim()) {
      this.showAllRows();
      filterInfo.classList.add('hidden');
      return;
    }
    
    const rows = document.querySelectorAll('#ridesTableBody tr');
    let visibleCount = 0;
    
    this.processBatchFilter(rows, (row) => {
      const operator = row.getAttribute('data-operator');
      const shouldShow = operator && operator.includes(operatorName);
      if (shouldShow) visibleCount++;
      return shouldShow;
    }, () => {
      filterInfo.classList.remove('hidden');
      filterInfoText.textContent = `מוצגות ${visibleCount} נסיעות של מפעילים המכילים "${operatorName}"`;
    });
  }

  // 8. עיבוד סינון בחלקים
  processBatchFilter(rows, filterFunc, callback) {
    let currentIndex = 0;
    const batchSize = 200;
    
    const processBatch = () => {
      const endIndex = Math.min(currentIndex + batchSize, rows.length);
      
      for (let i = currentIndex; i < endIndex; i++) {
        const row = rows[i];
        const shouldShow = filterFunc(row);
        row.style.display = shouldShow ? '' : 'none';
      }
      
      currentIndex = endIndex;
      
      if (currentIndex < rows.length) {
        setTimeout(processBatch, 1); // 1ms delay
      } else {
        callback();
      }
    };
    
    processBatch();
  }

  // 9. הצגת כל השורות
  showAllRows() {
    const rows = document.querySelectorAll('#ridesTableBody tr');
    rows.forEach(row => row.style.display = '');
  }

  // 10. ניקוי סינונים
  clearAllFilters() {
    document.getElementById('vehicleSearch').value = '';
    document.getElementById('lineSearch').value = '';
    document.getElementById('operatorSearch').value = '';
    this.hideLineDropdown(); // הוספה
    this.showAllRows();
    document.getElementById('filterInfo').classList.add('hidden');
  }

  // 11. מיון מאופטמ
  async sortTableOptimized(field) {
    if (currentSortField === field) {
      currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
      currentSortField = field;
      currentSortDirection = 'asc';
    }
    
    // *** שמירת הסינונים הנוכחיים - כולל זיהוי אם זה קו ספציפי ***
    const currentFilters = {
      vehicle: document.getElementById('vehicleSearch')?.value || '',
      line: document.getElementById('lineSearch')?.value || '',
      operator: document.getElementById('operatorSearch')?.value || '',
      isSpecificLine: false,
      selectedLine: null
    };
    
    // *** זיהוי אם הסינון הנוכחי הוא של קו ספציפי ***
    if (currentFilters.line) {
      // חיפוש אם יש קו שה-displayName שלו תואם לערך בשדה החיפוש
      const matchingLine = selectedLines.find(line => {
        const displayName = line.displayName || `קו ${line.routeNumber}`;
        return displayName === currentFilters.line;
      });
      
      if (matchingLine) {
        currentFilters.isSpecificLine = true;
        currentFilters.selectedLine = matchingLine;
      }
    }
    
    showLoading(true);
    updateProgress("ממיין נתונים...");
    
    // מיון הנתונים
    await new Promise(resolve => {
      setTimeout(() => {
        allRides.sort((a, b) => {
          let aVal = a[field];
          let bVal = b[field];
          
          if (!aVal && !bVal) return 0;
          if (!aVal) return 1;
          if (!bVal) return -1;
          
          if (field === 'vehicle_ref') {
            if (aVal !== bVal) {
              const comparison = aVal.localeCompare(bVal);
              return currentSortDirection === 'asc' ? comparison : -comparison;
            }
            const aTime = new Date(a.scheduled_start_time);
            const bTime = new Date(b.scheduled_start_time);
            return currentSortDirection === 'asc' ? aTime - bTime : bTime - aTime;
          }
          
          if (field === 'scheduled_start_time') {
            aVal = new Date(aVal);
            bVal = new Date(bVal);
          }
          
          if (field === 'line_number') {
            aVal = parseInt(aVal) || 0;
            bVal = parseInt(bVal) || 0;
          }
          
          if (aVal < bVal) return currentSortDirection === 'asc' ? -1 : 1;
          if (aVal > bVal) return currentSortDirection === 'asc' ? 1 : -1;
          return 0;
        });
        resolve();
      }, 50);
    });
    
    // רינדור מחדש
    await this.displayResultsChunked();
    
    // *** החזרת הסינונים אחרי הרינדור - עם טיפול נכון בקווים ספציפיים ***
    setTimeout(() => {
      if (currentFilters.vehicle) {
        document.getElementById('vehicleSearch').value = currentFilters.vehicle;
        this.debounceFilter('vehicle', currentFilters.vehicle);
      }
      
      if (currentFilters.line) {
        document.getElementById('lineSearch').value = currentFilters.line;
        
        if (currentFilters.isSpecificLine && currentFilters.selectedLine) {
          // *** אם זה קו ספציפי - השתמש בסינון הספציפי ***
          this.filterBySpecificLine(currentFilters.selectedLine);
        } else {
          // *** אם זה חיפוש כללי - השתמש בסינון הכללי ***
          this.debounceFilter('line', currentFilters.line);
        }
      }
      
      if (currentFilters.operator) {
        document.getElementById('operatorSearch').value = currentFilters.operator;
        this.debounceFilter('operator', currentFilters.operator);
      }
    }, 100);
  }

  // 12. קיבוץ מאופטמ לפי רכב
  async groupByVehicleOptimized() {
    showLoading(true);
    updateProgress("מקבץ נתונים לפי רכב...");
    
    await new Promise(resolve => {
      setTimeout(() => {
        const vehicleGroups = new Map();
        
        allRides.forEach(ride => {
          const vehicleRef = ride.vehicle_ref || 'לא זמין';
          if (!vehicleGroups.has(vehicleRef)) {
            vehicleGroups.set(vehicleRef, []);
          }
          vehicleGroups.get(vehicleRef).push(ride);
        });
        
        // מיון מספרי
        function naturalSort(a, b) {
          const aKey = a[0];
          const bKey = b[0];
          
          if (aKey === 'לא זמין') return 1;
          if (bKey === 'לא זמין') return -1;
          
          return aKey.localeCompare(bKey, undefined, {
            numeric: true,
            sensitivity: 'base'
          });
        }
        
        const sortedGroups = Array.from(vehicleGroups.entries()).sort(naturalSort);
        
        let groupHTML = `
          <div class="space-y-4">
            <h3 class="text-xl font-bold">קיבוץ לפי רכב (${sortedGroups.length} רכבים)</h3>
            <button onclick="ridesManager.displayResultsChunked()" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
              ← חזרה לתצוגה רגילה
            </button>
        `;
        
        sortedGroups.forEach(([vehicleRef, rides]) => {
          const firstRide = rides[0];
          const lastRide = rides[rides.length - 1];
          const firstTime = new Date(firstRide.scheduled_start_time).toLocaleTimeString('he-IL');
          const lastTime = new Date(lastRide.scheduled_start_time).toLocaleTimeString('he-IL');
          
          groupHTML += `
            <div class="border rounded-lg p-4 bg-white">
              <div class="flex justify-between items-center mb-2">
                <h4 class="font-bold text-lg">רכב ${vehicleRef}</h4>
                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">${rides.length} נסיעות</span>
              </div>
              <p class="text-gray-600 mb-2">
                מ-${firstTime} עד ${lastTime} | 
                קווים: ${[...new Set(rides.map(r => r.line_number))].join(', ')}
              </p>
              <button onclick="ridesManager.showVehicleDetails('${vehicleRef}')" 
                      class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">
                הצג פירוט
              </button>
            </div>
          `;
        });
        
        groupHTML += '</div>';
        document.getElementById("results").innerHTML = groupHTML;
        resolve();
      }, 50);
    });
    
    showLoading(false);
  }

  // 13. הצגת פרטי רכב
  async showVehicleDetails(vehicleRef) {
    await this.displayResultsChunked();
    document.getElementById('vehicleSearch').value = vehicleRef;
    this.debounceFilter('vehicle', vehicleRef);
  }

  // 14. ייצוא ל-CSV
  exportToCSV() {
    if (allRides.length === 0) {
      alert("אין נתונים לייצוא");
      return;
    }
    
    const headers = ['תאריך ושעה', 'מספר קו', 'חברה', 'מספר רישוי', 'line_ref', 'מוצא', 'יעד', 'חלופה'];
    const csvContent = [
      headers.join(','),
      ...allRides.map(ride => {
        const rideDate = new Date(ride.scheduled_start_time);
        return [
          `"${rideDate.toLocaleDateString('he-IL')} ${rideDate.toLocaleTimeString('he-IL')}"`,
          ride.line_number,
          `"${ride.operator_name}"`,
          `"${ride.vehicle_ref || 'לא זמין'}"`,
          ride.siri_route__line_ref,
          `"${ride.route_dest?.from || ""}"`,
          `"${ride.route_dest?.to || ""}"`,
          `"${ride.route_dest?.alternative || ""}"`
        ].join(',');
      })
    ].join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `rides_${document.getElementById("selectedDate").value}.csv`;
    link.click();
  }

  // 15. הצגת דרופדאון קווים חכם
  showLineDropdown(searchValue) {
    const dropdown = document.getElementById('lineDropdown');
    if (!dropdown) return;
    
    // קבלת רשימת קווים ייחודיים לפי routeMkt (לא routeNumber!)
    const uniqueLines = new Map();
    selectedLines.forEach(line => {
      // *** השתמש ב-routeMkt או בשילוב של operatorRef+routeNumber כמפתח ***
      const key = line.routeMkt || `${line.operatorRef}_${line.routeNumber}`;
      const display = line.displayName || `קו ${line.routeNumber}`;
      
      uniqueLines.set(key, {
        routeMkt: line.routeMkt,
        number: line.routeNumber,
        display: display,
        operator: line.operatorName,
        operatorRef: line.operatorRef
      });
    });
    
    // סינון לפי הטקסט שהוקלד
    const filteredLines = Array.from(uniqueLines.values()).filter(line => {
      if (!searchValue.trim()) return true;
      
      const searchLower = searchValue.toLowerCase();
      return (
        line.number.toString().includes(searchValue) ||
        line.display.toLowerCase().includes(searchLower) ||
        line.operator.toLowerCase().includes(searchLower)
      );
    });
    
    if (filteredLines.length === 0) {
      dropdown.classList.add('hidden');
      return;
    }
    
    // *** מיון הקווים לפי מספר קו (מיון מספרי) ***
    filteredLines.sort((a, b) => {
      const aNum = parseInt(a.number) || 0;
      const bNum = parseInt(b.number) || 0;
      return aNum - bNum;
    });
    
    // יצירת אפשרויות
    const optionsHTML = filteredLines.map(line => `
      <div class="p-2 hover:bg-blue-50 cursor-pointer border-b last:border-b-0" 
          onclick="ridesManager.selectLineFromDropdown('${line.routeMkt || ''}', '${line.operatorRef}', '${line.number}', '${line.display}')">
        <div class="font-bold">${line.display}</div>
        <div class="text-sm text-gray-600">${line.operator}</div>
      </div>
    `).join('');
    
    dropdown.innerHTML = optionsHTML || '<div class="p-2 text-gray-500">לא נמצאו קווים</div>';
    dropdown.classList.remove('hidden');
  }

  // 16. בחירת קו מהדרופדאון
  selectLineFromDropdown(routeMkt, operatorRef, routeNumber, displayName) {
    const lineSearchInput = document.getElementById('lineSearch');
    lineSearchInput.value = displayName;
    
    // *** מציאת הקו הנכון לפי routeMkt ***
    const selectedLine = selectedLines.find(line => {
      if (routeMkt) {
        return line.routeMkt === routeMkt;
      } else {
        // fallback למקרה של קווים ישנים ללא routeMkt
        return line.operatorRef === operatorRef && line.routeNumber === routeNumber;
      }
    });
    
    if (selectedLine) {
      // *** הפעלת הסינון לפי הקו הספציפי (לפי routeMkt) ***
      this.filterBySpecificLine(selectedLine);
    }
    
    // הסתרת הדרופדאון
    this.hideLineDropdown();
  }

  // 17. הסתרת דרופדאון
  hideLineDropdown() {
    const dropdown = document.getElementById('lineDropdown');
    if (dropdown) {
      dropdown.classList.add('hidden');
    }
  }

  // 18. עדכון פונקציית הסינון לקווים (לטקסט חופשי)
  filterByLine(lineNumber) {
    const filterInfo = document.getElementById('filterInfo');
    const filterInfoText = document.getElementById('filterInfoText');
    
    if (!lineNumber.trim()) {
      this.showAllRows();
      filterInfo.classList.add('hidden');
      this.hideLineDropdown();
      return;
    }
    
    // אם זה מספר - חפש מדויק, אם זה טקסט - חפש חלקי בתצוגה
    const isNumeric = /^\d+$/.test(lineNumber.trim());
    
    const rows = document.querySelectorAll('#ridesTableBody tr');
    let visibleCount = 0;
    
    this.processBatchFilter(rows, (row) => {
      const lineRef = row.getAttribute('data-line');
      
      if (isNumeric) {
        // חיפוש מדויק למספר
        const shouldShow = lineRef && lineRef === lineNumber;
        if (shouldShow) visibleCount++;
        return shouldShow;
      } else {
        // חיפוש חלקי לטקסט (שם עיר וכו')
        const rideData = allRides.find(ride => ride.line_number === lineRef);
        if (rideData) {
          const matchesLine = lineRef.includes(lineNumber);
          const matchesOperator = rideData.operator_name?.toLowerCase().includes(lineNumber.toLowerCase());
          const matchesRoute = rideData.route_dest?.from?.toLowerCase().includes(lineNumber.toLowerCase()) ||
                              rideData.route_dest?.to?.toLowerCase().includes(lineNumber.toLowerCase());
          
          const shouldShow = matchesLine || matchesOperator || matchesRoute;
          if (shouldShow) visibleCount++;
          return shouldShow;
        }
        return false;
      }
    }, () => {
      filterInfo.classList.remove('hidden');
      filterInfoText.textContent = `מוצגות ${visibleCount} נסיעות המכילות "${lineNumber}"`;
    });
  }

  // 19. סינון לפי קו ספציפי (לפי routeMkt)
  filterBySpecificLine(selectedLine) {
    const filterInfo = document.getElementById('filterInfo');
    const filterInfoText = document.getElementById('filterInfoText');
    
    const rows = document.querySelectorAll('#ridesTableBody tr');
    let visibleCount = 0;
    
    this.processBatchFilter(rows, (row) => {
      // *** חיפוש לפי route_mkt אם קיים, אחרת לפי שילוב operator_ref + route_number ***
      const routeMkt = row.getAttribute('data-route-mkt');
      const lineRef = row.getAttribute('data-line');
      const operator = row.getAttribute('data-operator');
      
      let shouldShow = false;
      
      if (selectedLine.routeMkt && routeMkt) {
        // השוואה מדויקת לפי route_mkt
        shouldShow = routeMkt === selectedLine.routeMkt;
      } else {
        // fallback - השוואה לפי מספר קו ומפעיל
        shouldShow = lineRef === selectedLine.routeNumber && 
                    operator === selectedLine.operatorName;
      }
      
      if (shouldShow) visibleCount++;
      return shouldShow;
    }, () => {
      filterInfo.classList.remove('hidden');
      const displayName = selectedLine.displayName || `קו ${selectedLine.routeNumber}`;
      filterInfoText.textContent = `מוצגות ${visibleCount} נסיעות של ${displayName}`;
    });
  }
}

// יצירת instance גלובלי
const ridesManager = new RidesTableManager();

  // ===============

  // החלפת הפונקציה הקיימת
  function displayResults() {
    ridesManager.displayResultsChunked();
  }
</script>
</body>
</html>