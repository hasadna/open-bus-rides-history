<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>××¢×§×‘ ××¡×¤×¨ ×§×•×•×™× - ×œ×•×— × ×¡×™×¢×•×ª ×¨×˜×¨×•××§×˜×™×‘×™</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <style>
    #mapContainer{
      min-height: 250px;
    }
    .sortable {
      cursor: pointer;
    }
    .sortable:hover {
      background-color: #f3f4f6;
    }
    .sort-indicator {
      margin-right: 5px;
    }
    .vehicle-group-border {
      border-top: 3px solid #2563eb !important;
      background-color: #eff6ff;
    }
  </style>
</head>
<body class="bg-gray-50 p-6 text-gray-800">

  <div class="max-w-6xl mx-auto bg-white p-6 rounded-2xl shadow-md space-y-4">
    <h1 class="text-2xl font-bold text-center mb-6">××¢×§×‘ ××¡×¤×¨ ×§×•×•×™× - ×œ×•×— × ×¡×™×¢×•×ª ×¨×˜×¨×•××§×˜×™×‘×™</h1>

    <!-- ×‘×—×™×¨×ª ×ª××¨×™×š -->
    <div class="bg-blue-50 p-4 rounded-lg">
      <div class="space-y-2">
        <label class="block font-medium" for="selectedDate">×ª××¨×™×š ×œ×‘×“×™×§×”:</label>
        <input id="selectedDate" type="date" class="w-full rounded-xl border border-gray-300 p-2" value="2025-05-18">
      </div>
    </div>

    <!-- ×¨×©×™××ª ×§×•×•×™× -->
    <div class="bg-gray-50 p-4 rounded-lg">
      <h2 class="text-lg font-bold mb-4">×¨×©×™××ª ×§×•×•×™× ×œ×‘×“×™×§×”</h2>
      
      <div id="linesList" class="space-y-3 mb-4">
        <!-- ×›××Ÿ ×™×ª×•×•×¡×¤×• ×”×§×•×•×™× ×©× ×‘×—×¨×• -->
      </div>

      <!-- ×”×•×¡×¤×ª ×§×• ×—×“×© -->
      <div class="border-2 border-dashed border-gray-300 p-4 rounded-lg">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
          <div class="space-y-2">
            <label class="block font-medium" for="newOperatorSelect">×‘×—×¨ ××¤×¢×™×œ:</label>
            <select id="newOperatorSelect" class="w-full rounded-xl border border-gray-300 p-2">
              <option value="">×˜×•×¢×Ÿ...</option>
            </select>
          </div>
          
          <div class="space-y-2">
            <label class="block font-medium" for="newRouteNumber">××¡×¤×¨ ×§×• (1-999):</label>
            <input id="newRouteNumber" type="number" min="1" max="999" placeholder="×œ×“×•×’××”: 402" class="w-full rounded-xl border border-gray-300 p-2">
          </div>
          
          <button onclick="addNewLine()" class="bg-green-600 text-white p-2 rounded-xl hover:bg-green-700 transition flex items-center justify-center">
            <span class="text-xl mr-2">+</span> ×”×•×¡×£ ×§×•
          </button>
          
          <button onclick="loadAllOperatorRoutes()" class="bg-purple-600 text-white p-2 rounded-xl hover:bg-purple-700 transition flex items-center justify-center">
            <span class="text-xl mr-2">ğŸ“‹</span> ×˜×¢×Ÿ ×›×œ ×§×•×•×™ ×”××¤×¢×™×œ
          </button>
        </div>
        
        <!-- ×™×™×‘×•× CSV -->
        <div class="mt-4 pt-4 border-t border-gray-200">
          <div class="flex items-center gap-3">
            <label for="csvFile" class="bg-blue-600 text-white px-4 py-2 rounded-xl hover:bg-blue-700 transition cursor-pointer">
              ğŸ“ ×™×™×‘×•× ×-CSV
            </label>
            <input type="file" id="csvFile" accept=".csv" class="hidden" onchange="importFromCSV(event)">
            <span class="text-sm text-gray-600">×¤×•×¨××˜: ××¡×¤×¨ ×§×•,×—×‘×¨×”</span>
            <button onclick="clearAllLines()" class="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition text-sm">
              ğŸ—‘ï¸ × ×§×” ×”×›×œ
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×” -->
    <div class="flex space-x-3 rtl:space-x-reverse">
      <button onclick="loadAllRides()" class="bg-blue-600 text-white px-6 py-2 rounded-xl hover:bg-blue-700 transition">
        ×˜×¢×Ÿ ××ª ×›×œ ×”× ×¡×™×¢×•×ª
      </button>
      <button onclick="clearResults()" class="bg-gray-500 text-white px-6 py-2 rounded-xl hover:bg-gray-600 transition">
        × ×§×” ×ª×•×¦××•×ª
      </button>
    </div>

    <!-- ×ª×•×¦××•×ª -->
    <div id="results" class="mt-6"></div>
    
    <!-- ××™× ×“×™×§×˜×•×¨ ×˜×¢×™× ×” -->
    <div id="loadingIndicator" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full">
        <p class="text-blue-600 text-center">×˜×•×¢×Ÿ × ×ª×•× ×™×...</p>
        <div id="progressText" class="text-gray-600 text-center mt-2">××›×™×Ÿ ×œ×˜×¢×™× ×”...</div>
      </div>
    </div>
  </div>

  <script>
  let selectedLines = [];
  let allRides = [];
  let currentSortField = 'scheduled_start_time';
  let currentSortDirection = 'asc';

  // ×˜×¢×™× ×ª ××¤×¢×™×œ×™× ×‘×˜×¢×™× ×ª ×”×“×£
  document.addEventListener("DOMContentLoaded", () => {
    loadOperators();
    document.getElementById("selectedDate").addEventListener("change", loadOperators);
  });

  // ×¤×•× ×§×¦×™×” ×œ×˜×¢×™× ×ª ××¤×¢×™×œ×™×
  async function loadOperators() {
    const selectedDate = document.getElementById("selectedDate").value;
    
    try {
      const res = await fetch(`https://open-bus-stride-api.hasadna.org.il/gtfs_agencies/list?limit=100&date_from=${selectedDate}&date_to=${selectedDate}`);
      let data = await res.json();
      
      // ×× ×”×ª×§×‘×œ ××¢×¨×š ×¨×™×§, ×”×©×ª××© ×‘×¨×©×™××” ×“×™×¤×•×œ×˜×™×‘×™×ª
      if (!data || data.length === 0) {
        data = [{"date":"2025-05-01","operator_ref":3,"agency_name":"××’×“"},{"date":"2025-05-01","operator_ref":25,"agency_name":"××œ×§×˜×¨×” ××¤×™×§×™×"},{"date":"2025-05-01","operator_ref":4,"agency_name":"××œ×§×˜×¨×” ××¤×™×§×™× ×ª×—×‘×•×¨×”"},{"date":"2025-05-01","operator_ref":37,"agency_name":"××§×¡×˜×¨×”"},{"date":"2025-05-01","operator_ref":38,"agency_name":"××§×¡×˜×¨×” ×™×¨×•×©×œ×™×"},{"date":"2025-05-01","operator_ref":35,"agency_name":"×‘×™×ª ×©××© ××§×¡×¤×¨×¡"},{"date":"2025-05-01","operator_ref":8,"agency_name":"×’×™.×‘×™.×˜×•×¨×¡"},{"date":"2025-05-01","operator_ref":23,"agency_name":"×’×œ×™×"},{"date":"2025-05-01","operator_ref":5,"agency_name":"×“×Ÿ"},{"date":"2025-05-01","operator_ref":32,"agency_name":"×“×Ÿ ×‘××¨ ×©×‘×¢"},{"date":"2025-05-01","operator_ref":31,"agency_name":"×“×Ÿ ×‘×“×¨×•×"},{"date":"2025-05-01","operator_ref":135,"agency_name":"×“×¨×š ××’×“ ×¢×•×˜×£ ×™×¨×•×©×œ×™×"},{"date":"2025-05-01","operator_ref":44,"agency_name":"×™×¨×•×©×œ×™×-××‘×•-×ª×•×¨-×¢× ××ª× ××™×—×•×“"},{"date":"2025-05-01","operator_ref":45,"agency_name":"×™×¨×•×©×œ×™×-××œ×•×•×¡×˜ ××™×—×•×“"},{"date":"2025-05-01","operator_ref":50,"agency_name":"×™×¨×•×©×œ×™×-×“×¨×•× ××™×—×•×“"},{"date":"2025-05-01","operator_ref":47,"agency_name":"×™×¨×•×©×œ×™×-×”×¨ ×”×–×™×ª×™×"},{"date":"2025-05-01","operator_ref":49,"agency_name":"×™×¨×•×©×œ×™× - ×¢×™×¡××•×•×™×” ××—× ×” ×©×¢×¤××˜ ××™×—×•×“"},{"date":"2025-05-01","operator_ref":51,"agency_name":"×™×¨×•×©×œ×™×-×¦×•×¨ ×‘××”×¨ ××™×—×•×“"},{"date":"2025-05-01","operator_ref":42,"agency_name":"×™×¨×•×©×œ×™×-×¨×××œ×œ×” ××™×—×•×“"},{"date":"2025-05-01","operator_ref":33,"agency_name":"×›×‘×œ ××§×¡×¤×¨×¡"},{"date":"2025-05-01","operator_ref":21,"agency_name":"×›×¤×™×¨"},{"date":"2025-05-01","operator_ref":20,"agency_name":"×›×¨××œ×™×ª"},{"date":"2025-05-01","operator_ref":91,"agency_name":"××•× ×™×•×ª ××˜×¨×• ×§×•"},{"date":"2025-05-01","operator_ref":10,"agency_name":"××•×¢×¦×” ××–×•×¨×™×ª ××™×œ×•×ª"},{"date":"2025-05-01","operator_ref":24,"agency_name":"××•×¢×¦×” ××–×•×¨×™×ª ×’×•×œ×Ÿ"},{"date":"2025-05-01","operator_ref":15,"agency_name":"××˜×¨×•×¤×•×œ×™×Ÿ"},{"date":"2025-05-01","operator_ref":7,"agency_name":"× ×¡×™×¢×•×ª ×•×ª×™×™×¨×•×ª"},{"date":"2025-05-01","operator_ref":14,"agency_name":"× ×ª×™×‘ ××§×¡×¤×¨×¡"},{"date":"2025-05-01","operator_ref":16,"agency_name":"×¡×•×¤×¨×‘×•×¡"},{"date":"2025-05-01","operator_ref":18,"agency_name":"×§×•×•×™×"},{"date":"2025-05-01","operator_ref":2,"agency_name":"×¨×›×‘×ª ×™×©×¨××œ"},{"date":"2025-05-01","operator_ref":6,"agency_name":"×©.×.×"},{"date":"2025-05-01","operator_ref":22,"agency_name":"×ª×‘×œ"},{"date":"2025-05-01","operator_ref":34,"agency_name":"×ª× ×•×¤×”"}];
      }
      
      // ×”×¡×¨×ª ×›×¤×™×œ×•×™×•×ª ×œ×¤×™ operator_ref
      const uniqueOperators = new Map();
      data.forEach(op => {
        if (!uniqueOperators.has(op.operator_ref)) {
          uniqueOperators.set(op.operator_ref, op);
        }
      });
      
      const select = document.getElementById("newOperatorSelect");
      select.innerHTML = '<option value="">×‘×—×¨ ××¤×¢×™×œ</option>';
      
      // ×××™×™× ×™× ×œ×¤×™ ×©× ×”××¤×¢×™×œ
      Array.from(uniqueOperators.values())
        .sort((a, b) => a.agency_name.localeCompare(b.agency_name, 'he'))
        .forEach(op => {
          const option = document.createElement("option");
          option.value = op.operator_ref;
          option.textContent = op.agency_name;
          option.setAttribute('data-name', op.agency_name);
          select.appendChild(option);
        });
    } catch (error) {
      console.error("×©×’×™××” ×‘×˜×¢×™× ×ª ×¨×©×™××ª ×”××¤×¢×™×œ×™×:", error);
    }
  }

  // ×¤×•× ×§×¦×™×” ×œ×”×•×¡×¤×ª ×§×• ×—×“×©
  // ×¤×•× ×§×¦×™×” ×œ×”×•×¡×¤×ª ×§×• ×—×“×© - ×¢× ×‘×—×™×¨×ª ×—×œ×•×¤×•×ª
  async function addNewLine() {
    const operatorSelect = document.getElementById("newOperatorSelect");
    const routeNumber = document.getElementById("newRouteNumber").value.trim();
    
    if (!operatorSelect.value || !routeNumber) {
      alert("× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª");
      return;
    }
    
    const operatorRef = operatorSelect.value;
    const operatorName = operatorSelect.options[operatorSelect.selectedIndex].getAttribute('data-name');
    const selectedDate = document.getElementById("selectedDate").value;
    
    try {
      // ×§×‘×œ×ª ×—×œ×•×¤×•×ª ×”×§×•
      const routesUrl = `https://open-bus-stride-api.hasadna.org.il/gtfs_routes/list?operator_refs=${operatorRef}&route_short_name=${routeNumber}&date_from=${selectedDate}&date_to=${selectedDate}`;
      const routesRes = await fetch(routesUrl);
      const routesData = await routesRes.json();
      
      if (routesData.length === 0) {
        alert(`×œ× × ××¦× ×§×• ${routeNumber} ×¢×‘×•×¨ ${operatorName} ×‘×ª××¨×™×š ${selectedDate}`);
        return;
      }
      
      // ×§×™×‘×•×¥ ×œ×¤×™ route_mkt
      const routeGroups = new Map();
      routesData.forEach(route => {
        const routeMkt = route.route_mkt;
        if (!routeGroups.has(routeMkt)) {
          routeGroups.set(routeMkt, []);
        }
        routeGroups.get(routeMkt).push(route);
      });
      
      // ×× ×™×© ×¨×§ ×—×œ×•×¤×” ××—×ª - ×”×•×¡×£ ×™×©×™×¨×•×ª
      if (routeGroups.size === 1) {
        const [routeMkt] = routeGroups.keys();
        const existingLine = selectedLines.find(line => 
          line.operatorRef === operatorRef && line.routeMkt === routeMkt
        );
        
        if (existingLine) {
          alert("×§×• ×–×” ×›×‘×¨ × ××¦× ×‘×¨×©×™××”");
          return;
        }
        
        const firstRoute = routeGroups.get(routeMkt)[0];
        const newLine = {
          id: Date.now(),
          operatorRef: operatorRef,
          operatorName: operatorName,
          routeNumber: routeNumber,
          routeMkt: routeMkt,
          displayName: `×§×• ${routeNumber} - ${extractCityNames(firstRoute.route_long_name)}`
        };
        
        selectedLines.push(newLine);
        updateLinesDisplay();
        document.getElementById("newRouteNumber").value = '';
        return;
      }
      
      // ×× ×™×© ××¡×¤×¨ ×—×œ×•×¤×•×ª - ×”×¦×’ ×“×™××œ×•×’ ×‘×—×™×¨×”
      showRouteVariantsDialog(operatorRef, operatorName, routeNumber, routeGroups);
      
    } catch (error) {
      console.error("×©×’×™××” ×‘×˜×¢×™× ×ª ×—×œ×•×¤×•×ª ×”×§×•:", error);
      alert(`×©×’×™××” ×‘×˜×¢×™× ×ª ×—×œ×•×¤×•×ª ×”×§×•: ${error.message}`);
    }
  }

  // ×¤×•× ×§×¦×™×” ×œ×—×™×œ×•×¥ ×©××•×ª ×¢×¨×™× ××ª×™××•×¨ ×”××¡×œ×•×œ
function extractCityNames(routeLongName) {
  try {
    // ×—×™×œ×•×¥ ××•×¦× ×•×™×¢×“ ××”×¤×•×¨××˜: "××•×¦×-×¢×™×¨<->×™×¢×“-×¢×™×¨-XX"
    const match = routeLongName.match(/^(.+?)-([^<]+)<->(.+?)-([^-]+)/);
    if (match) {
      const fromCity = match[2].trim();
      const toCity = match[4].trim();
      return `${fromCity} â†” ${toCity}`;
    }
    return routeLongName.substring(0, 50) + "...";
  } catch (error) {
    return "××¡×œ×•×œ ×œ× ×–××™×Ÿ";
  }
}

// ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ×“×™××œ×•×’ ×‘×—×™×¨×ª ×—×œ×•×¤×•×ª
function showRouteVariantsDialog(operatorRef, operatorName, routeNumber, routeGroups) {
  const dialog = document.createElement('div');
  dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
  dialog.setAttribute('data-dialog', 'route-variants');
  
  let variantsHTML = '';
  routeGroups.forEach((routes, routeMkt) => {
    const firstRoute = routes[0];
    const cityNames = extractCityNames(firstRoute.route_long_name);
    const isAlreadySelected = selectedLines.find(line => 
      line.operatorRef === operatorRef && line.routeMkt === routeMkt
    );
    
    variantsHTML += `
      <div class="border rounded-lg p-3 ${isAlreadySelected ? 'bg-gray-100 opacity-50' : 'bg-white hover:bg-blue-50 cursor-pointer'}" 
           ${!isAlreadySelected ? `onclick="selectRouteVariant('${operatorRef}', '${operatorName}', '${routeNumber}', '${routeMkt}', '${cityNames}')"` : ''}>
        <div class="font-bold">×§×• ${routeNumber} - ${cityNames}</div>
        <div class="text-sm text-gray-600">${routes.length} ×›×™×•×•× ×™×</div>
        ${isAlreadySelected ? '<div class="text-xs text-red-600">×›×‘×¨ × ×‘×—×¨</div>' : ''}
      </div>
    `;
  });
  
  dialog.innerHTML = `
    <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold">×‘×—×¨ ×—×œ×•×¤×ª ×§×• ${routeNumber}</h3>
        <button onclick="this.closest('[data-dialog=\"route-variants\"]').remove()" class="text-gray-500 hover:text-gray-800">Ã—</button>
      </div>
      <div class="space-y-2 max-h-60 overflow-y-auto">
        ${variantsHTML}
      </div>
      <div class="mt-4 text-sm text-gray-600">
        * × ×™×ª×Ÿ ×œ×‘×—×•×¨ ××¡×¤×¨ ×—×œ×•×¤×•×ª ×©×œ ××•×ª×• ×§×•
      </div>
    </div>
  `;
  
  document.body.appendChild(dialog);
}

// ×¤×•× ×§×¦×™×” ×œ×‘×—×™×¨×ª ×—×œ×•×¤×ª ×§×•
function selectRouteVariant(operatorRef, operatorName, routeNumber, routeMkt, displayName) {
  const newLine = {
    id: Date.now(),
    operatorRef: operatorRef,
    operatorName: operatorName,
    routeNumber: routeNumber,
    routeMkt: routeMkt,
    displayName: `×§×• ${routeNumber} - ${displayName}`
  };
  
  selectedLines.push(newLine);
  updateLinesDisplay();
  document.getElementById("newRouteNumber").value = '';
  
  // *** ×ª×™×§×•×Ÿ: ×—×™×¤×•×© ×¡×¤×¦×™×¤×™ ×™×•×ª×¨ ***
  const routeDialog = event.target.closest('.fixed[data-dialog="route-variants"]');
  if (routeDialog) {
    routeDialog.remove();
  }
}

  // ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×ª×¦×•×’×ª ×”×§×•×•×™×
  function updateLinesDisplay() {
    const container = document.getElementById("linesList");
    
    if (selectedLines.length === 0) {
      container.innerHTML = '<p class="text-gray-500 text-center">×œ× × ×‘×—×¨×• ×§×•×•×™× ×¢×“×™×™×Ÿ</p>';
      return;
    }
    
    container.innerHTML = `
      <div class="flex flex-wrap gap-2">
        ${selectedLines.map(line => `
          <div class="flex items-center bg-white px-3 py-2 rounded-lg border min-w-fit">
            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full font-bold text-sm">${line.displayName || `×§×• ${line.routeNumber}`}</span>
            <span class="text-gray-700 text-sm mx-2">${line.operatorName}</span>
            <button onclick="removeLine(${line.id})" class="text-red-500 hover:text-red-700 font-bold text-lg">Ã—</button>
          </div>
        `).join('')}
      </div>
    `;
  }

  // ×¤×•× ×§×¦×™×” ×œ×”×¡×¨×ª ×§×•
  function removeLine(lineId) {
    selectedLines = selectedLines.filter(line => line.id !== lineId);
    updateLinesDisplay();
  }

  // *** ×”×ª×™×§×•×Ÿ ×”×¢×™×§×¨×™ ×›××Ÿ ***
  // ×¤×•× ×§×¦×™×” ×œ×˜×¢×™× ×ª ×›×œ ×”× ×¡×™×¢×•×ª - ×¤×•×¤××¤ × ×¡×’×¨ ×¨×§ ×‘×¡×•×£ ×”×¨×™× ×“×•×¨
  async function loadAllRides() {
    if (selectedLines.length === 0) {
      alert("× × ×œ×”×•×¡×™×£ ×œ×¤×—×•×ª ×§×• ××—×“ ×œ×‘×“×™×§×”");
      return;
    }
    
    const selectedDate = document.getElementById("selectedDate").value;
    if (!selectedDate) {
      alert("× × ×œ×‘×—×•×¨ ×ª××¨×™×š");
      return;
    }
    
    showLoading(true);
    updateProgress("××›×™×Ÿ ×œ×˜×¢×™× ×”...");
    
    allRides = [];
    let totalLines = selectedLines.length;
    
    try {
      for (let i = 0; i < selectedLines.length; i++) {
        const line = selectedLines[i];
        updateProgress(`×˜×•×¢×Ÿ ×§×• ${line.routeNumber} ×©×œ ${line.operatorName} (${i + 1}/${totalLines})`);
        
        const rides = await loadRidesForLine(line, selectedDate);
        allRides = [...allRides, ...rides];
      }
      
      // ××™×•×Ÿ ×œ×¤×™ ×©×¢×ª ×™×¦×™××”
      allRides.sort((a, b) => a.scheduled_start_time - b.scheduled_start_time);
      
      // ×”×¤×•×¤××¤ ×××©×™×š ×œ×”×™×•×ª ×¤×ª×•×— ×•×™×™×¡×’×¨ ×¨×§ ×‘×¡×•×£ displayResults
      displayResults();
      
    } catch (error) {
      console.error("×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×¡×™×¢×•×ª:", error);
      alert(`×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×¡×™×¢×•×ª: ${error.message}`);
      showLoading(false); // ×¡×’×™×¨×ª ×¤×•×¤××¤ ×¨×§ ×‘××§×¨×” ×©×œ ×©×’×™××”
    }
    // ×”×¡×¨× ×• ××ª finally - ×”×¤×•×¤××¤ ×™×™×¡×’×¨ ×¨×§ ××—×¨×™ ×’××¨ ×”×¨×™× ×“×•×¨ ×”××œ×
  }

  // ×¤×•× ×§×¦×™×” ×œ×˜×¢×™× ×ª × ×¡×™×¢×•×ª ×¢×‘×•×¨ ×§×• ×¡×¤×¦×™×¤×™
  async function loadRidesForLine(line, selectedDate) {
    try {
      // ×˜×¢×™× ×ª ×—×œ×•×¤×•×ª ×”×§×•
      const routesUrl = line.routeMkt 
  ? `https://open-bus-stride-api.hasadna.org.il/gtfs_routes/list?operator_refs=${line.operatorRef}&route_mkt=${line.routeMkt}&date_from=${selectedDate}&date_to=${selectedDate}`
  : `https://open-bus-stride-api.hasadna.org.il/gtfs_routes/list?operator_refs=${line.operatorRef}&route_short_name=${line.routeNumber}&date_from=${selectedDate}&date_to=${selectedDate}`;
      const routesRes = await fetch(routesUrl);
      const routesData = await routesRes.json();
      
      if (routesData.length === 0) {
        console.log(`×œ× × ××¦××• ×—×œ×•×¤×•×ª ×¢×‘×•×¨ ×§×• ${line.routeNumber} ×©×œ ${line.operatorName}`);
        return [];
      }
      
      // ××™×—×•×“ ×œ×¤×™ line_ref
      const uniqueRoutes = new Map();
      routesData.forEach(route => {
        if (!uniqueRoutes.has(route.line_ref)) {
          uniqueRoutes.set(route.line_ref, route);
        }
      });
      
      const lineRefs = Array.from(uniqueRoutes.keys()).join(',');
      
      // ×˜×¢×™× ×ª × ×¡×™×¢×•×ª
      const startTime = new Date(`${selectedDate}T00:00:00`).getTime();
      const endTime = new Date(`${selectedDate}T23:59:59`).getTime();
      
      // ×§×‘×œ×ª ×¡×¤×™×¨×ª ×”×ª×•×¦××•×ª ×ª×—×™×œ×”
      const countUrl = `https://open-bus-stride-api.hasadna.org.il/siri_rides/list?get_count=1&scheduled_start_time_from=${startTime}&scheduled_start_time_to=${endTime}&siri_route__line_refs=${lineRefs}`;
      const countResponse = await fetch(countUrl);
      const totalCount = parseInt(await countResponse.text(), 10);
      
      if (totalCount === 0) {
        return [];
      }
      
      // ×˜×¢×™× ×ª ×›×œ ×”× ×¡×™×¢×•×ª
      let rides = [];
      const batchSize = 100;
      const batchCount = Math.ceil(totalCount / batchSize);
      
      for (let batchIndex = 0; batchIndex < batchCount; batchIndex++) {
        const offset = batchIndex * batchSize;
        const batchUrl = `https://open-bus-stride-api.hasadna.org.il/siri_rides/list?scheduled_start_time_from=${startTime}&scheduled_start_time_to=${endTime}&siri_route__line_refs=${lineRefs}&limit=${batchSize}&offset=${offset}`;
        const batchResponse = await fetch(batchUrl);
        const batchData = await batchResponse.json();
        rides = [...rides, ...batchData];
      }
      
      // ×”×•×¡×¤×ª ××™×“×¢ ×¢×œ ×”×§×• ×•×”××¤×¢×™×œ ×œ×›×œ × ×¡×™×¢×”
      rides.forEach(ride => {
        ride.line_number = line.routeNumber;
        ride.operator_name = line.operatorName;
        ride.operator_ref = line.operatorRef;
        ride.route_mkt = line.routeMkt; // *** ×”×•×¡×¤×ª route_mkt ×œ× ×ª×•× ×™ ×”× ×¡×™×¢×” ***
        
        // ××¦×™××ª ×”×—×œ×•×¤×” ×”××ª××™××”
        const routeVariant = Array.from(uniqueRoutes.values()).find(route => route.line_ref === ride.siri_route__line_ref);
        if (routeVariant) {
          try {
            // ×¤×™×¦×•×œ ×œ×¤×™ <-> ×•××– ××¦×™××ª ×”××™× ×•×¡ ×”××—×¨×•×Ÿ
            const parts = routeVariant.route_long_name.split('<->');
            if (parts.length === 2) {
              const lastDashIndex = parts[1].lastIndexOf('-');
              ride.route_dest = {
                from: parts[0].trim(),
                to: lastDashIndex !== -1 ? parts[1].substring(0, lastDashIndex).trim() : parts[1].trim(),
                alternative: lastDashIndex !== -1 ? parts[1].substring(lastDashIndex + 1).trim() : '',
              };
            } else {
              ride.route_dest = { from: routeVariant.route_long_name, to: '', alternative: '' };
            }
          } catch (error) {
            ride.route_dest = { from: '', to: '', alternative: '' };
          }
        }
      });
      
      return rides;
      
    } catch (error) {
      console.error(`×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™× ×¢×‘×•×¨ ×§×• ${line.routeNumber}:`, error);
      return [];
    }
  }

  // ×¤×•× ×§×¦×™×” ×œ×˜×¢×™× ×ª ×›×œ ×§×•×•×™ ×”××¤×¢×™×œ
  async function loadAllOperatorRoutes() {
    const operatorSelect = document.getElementById("newOperatorSelect");
    
    if (!operatorSelect.value) {
      alert("× × ×œ×‘×—×•×¨ ××¤×¢×™×œ ×ª×—×™×œ×”");
      return;
    }
    
    const operatorRef = operatorSelect.value;
    const operatorName = operatorSelect.options[operatorSelect.selectedIndex].getAttribute('data-name');
    const selectedDate = document.getElementById("selectedDate").value;
    
    if (!selectedDate) {
      alert("× × ×œ×‘×—×•×¨ ×ª××¨×™×š");
      return;
    }
    
    showLoading(true);
    updateProgress(`×˜×•×¢×Ÿ ××ª ×›×œ ×§×•×•×™ ${operatorName}...`);
    
    try {
      // ×§×‘×œ×ª ×›×œ ×”×§×•×•×™× ×©×œ ×”××¤×¢×™×œ
      const routesUrl = `https://open-bus-stride-api.hasadna.org.il/gtfs_routes/list?operator_refs=${operatorRef}&date_from=${selectedDate}&date_to=${selectedDate}&limit=-1`;
      const routesRes = await fetch(routesUrl);
      const routesData = await routesRes.json();
      
      if (routesData.length === 0) {
        alert(`×œ× × ××¦××• ×§×•×•×™× ×¢×‘×•×¨ ${operatorName} ×‘×ª××¨×™×š ${selectedDate}`);
        return;
      }
      
      // *** ×§×™×‘×•×¥ ×œ×¤×™ route_mkt ×‘××§×•× route_short_name ***
      const routeGroups = new Map();
      routesData.forEach(route => {
        const routeMkt = route.route_mkt;
        const routeNumber = route.route_short_name;
        
        if (routeMkt && routeNumber) {
          if (!routeGroups.has(routeMkt)) {
            routeGroups.set(routeMkt, {
              routeMkt: routeMkt,
              routeNumber: routeNumber,
              displayName: `×§×• ${routeNumber} - ${extractCityNames(route.route_long_name)}`,
              routes: []
            });
          }
          routeGroups.get(routeMkt).routes.push(route);
        }
      });
      
      updateProgress(`× ××¦××• ${routeGroups.size} ×§×•×•×™× ×™×™×—×•×“×™×™× (×œ×¤×™ route_mkt)...`);
      
      // ×”×•×¡×¤×ª ×”×§×•×•×™× ×”×—×“×©×™× (××ª×¢×œ××™× ××›×¤×™×œ×•×™×•×ª ×©×›×‘×¨ ×§×™×™××•×ª)
      let addedCount = 0;
      let skippedCount = 0;
      
      routeGroups.forEach((routeGroup, routeMkt) => {
        // *** ×‘×“×™×§×” ×× ×”×§×• ×›×‘×¨ ×§×™×™× ×œ×¤×™ route_mkt ***
        const existingLine = selectedLines.find(line => 
          line.operatorRef === operatorRef && line.routeMkt === routeMkt
        );
        
        if (existingLine) {
          skippedCount++;
          return;
        }
        
        // ×”×•×¡×¤×ª ×”×§×• ×”×—×“×© ×¢× route_mkt
        const newLine = {
          id: Date.now() + Math.random(), // ×× ×™×¢×ª ×”×ª× ×’×©×•×ª ID
          operatorRef: operatorRef,
          operatorName: operatorName,
          routeNumber: routeGroup.routeNumber,
          routeMkt: routeMkt, // *** ×”×•×¡×¤×ª route_mkt ***
          displayName: routeGroup.displayName
        };
        
        selectedLines.push(newLine);
        addedCount++;
      });
      
      // ×¢×“×›×•×Ÿ ×”×ª×¦×•×’×”
      updateLinesDisplay();
      
      // ×”×•×“×¢×” ×¢×œ ×”×ª×•×¦××•×ª
      let message = `× ×•×¡×¤×• ${addedCount} ×§×•×•×™× ×—×“×©×™× ×${operatorName}`;
      if (skippedCount > 0) {
        message += `\n${skippedCount} ×§×•×•×™× ×›×‘×¨ ×”×™×• ×‘×¨×©×™××”`;
      }
      alert(message);
      
    } catch (error) {
      console.error("×©×’×™××” ×‘×˜×¢×™× ×ª ×§×•×•×™ ×”××¤×¢×™×œ:", error);
      alert(`×©×’×™××” ×‘×˜×¢×™× ×ª ×§×•×•×™ ×”××¤×¢×™×œ: ${error.message}`);
    } finally {
      showLoading(false);
    }
  }

  // ×¤×•× ×§×¦×™×” ×œ××™×•×Ÿ ×”×˜×‘×œ×”
  function sortTable(field) {
    if (currentSortField === field) {
      currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
      currentSortField = field;
      currentSortDirection = 'asc';
    }
    
    allRides.sort((a, b) => {
      let aVal = a[field];
      let bVal = b[field];
      
      // ×˜×™×¤×•×œ ×‘×¢×¨×›×™× ×¨×™×§×™×
      if (!aVal && !bVal) return 0;
      if (!aVal) return 1;
      if (!bVal) return -1;
      
      // ××™×•×Ÿ ××™×•×—×“ ×œ×¤×™ ××¡×¤×¨ ×¨×™×©×•×™ + ×©×¢×ª ×™×¦×™××” ×œ×–×™×”×•×™ × ×¡×™×¢×•×ª ×¦××•×“×•×ª
      if (field === 'vehicle_ref') {
        // ××™×•×Ÿ ×¨××©×•× ×™ ×œ×¤×™ ××¡×¤×¨ ×¨×™×©×•×™
        if (aVal !== bVal) {
          const comparison = aVal.localeCompare(bVal);
          return currentSortDirection === 'asc' ? comparison : -comparison;
        }
        // ×× ××¡×¤×¨ ×”×¨×™×©×•×™ ×–×”×”, ××™×•×Ÿ ×œ×¤×™ ×©×¢×ª ×™×¦×™××”
        const aTime = new Date(a.scheduled_start_time);
        const bTime = new Date(b.scheduled_start_time);
        return currentSortDirection === 'asc' ? aTime - bTime : bTime - aTime;
      }
      
      // ×˜×™×¤×•×œ ×‘×¢×¨×›×™ ×–××Ÿ
      if (field === 'scheduled_start_time') {
        aVal = new Date(aVal);
        bVal = new Date(bVal);
      }
      
      // ×˜×™×¤×•×œ ×‘××¡×¤×¨×™×
      if (field === 'line_number') {
        aVal = parseInt(aVal) || 0;
        bVal = parseInt(bVal) || 0;
      }
      
      // ×”×©×•×•××”
      if (aVal < bVal) return currentSortDirection === 'asc' ? -1 : 1;
      if (aVal > bVal) return currentSortDirection === 'asc' ? 1 : -1;
      return 0;
    });
    
    displayResults();
  }

  // ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ××™× ×“×™×§×˜×•×¨ ××™×•×Ÿ
  function getSortIndicator(field) {
    if (currentSortField !== field) return 'â†•ï¸';
    return currentSortDirection === 'asc' ? 'â¬†ï¸' : 'â¬‡ï¸';
  }

  // ×¤×•× ×§×¦×™×” ×œ×™×™×‘×•× ×§×•×•×™× ×-CSV
  async function importFromCSV(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    try {
      const text = await file.text();
      const lines = text.trim().split('\n');
      
      // ×‘×“×™×§×” ×× ×”×©×•×¨×” ×”×¨××©×•× ×” ×”×™× ×›×•×ª×¨×ª
      const firstLine = lines[0].toLowerCase();
      const hasHeader = firstLine.includes('××¡×¤×¨') || firstLine.includes('×—×‘×¨×”') || firstLine.includes('×§×•');
      const dataLines = hasHeader ? lines.slice(1) : lines;
      
      let importedCount = 0;
      let skippedCount = 0;
      
      for (const line of dataLines) {
        if (!line.trim()) continue;
        
        const [routeNumber, operatorName] = line.split(',').map(s => s.trim());
        
        if (!routeNumber || !operatorName) {
          console.warn(`×©×•×¨×” ×œ× ×ª×§×™× ×”: ${line}`);
          skippedCount++;
          continue;
        }
        
        // ×—×™×¤×•×© ×”××¤×¢×™×œ ×‘×¨×©×™××”
        const operatorSelect = document.getElementById("newOperatorSelect");
        let operatorRef = null;
        
        for (let i = 0; i < operatorSelect.options.length; i++) {
          const option = operatorSelect.options[i];
          const optionName = option.getAttribute('data-name');
          if (optionName && optionName.includes(operatorName)) {
            operatorRef = option.value;
            break;
          }
        }
        
        if (!operatorRef) {
          console.warn(`××¤×¢×™×œ ×œ× × ××¦×: ${operatorName}`);
          skippedCount++;
          continue;
        }
        
        // ×‘×“×™×§×” ×× ×”×§×• ×›×‘×¨ ×§×™×™×
        const existingLine = selectedLines.find(line => 
          line.operatorRef === operatorRef && line.routeNumber === routeNumber
        );
        
        if (existingLine) {
          skippedCount++;
          continue;
        }
        
        // ×”×•×¡×¤×ª ×”×§×•
        const newLine = {
          id: Date.now() + Math.random(), // ×× ×™×¢×ª ×”×ª× ×’×©×•×ª ID
          operatorRef: operatorRef,
          operatorName: operatorName,
          routeNumber: routeNumber
        };
        
        selectedLines.push(newLine);
        importedCount++;
      }
      
      updateLinesDisplay();
      
      // ×”×•×“×¢×” ×¢×œ ×”×ª×•×¦××•×ª
      let message = `×™×•×‘××• ${importedCount} ×§×•×•×™× ×‘×”×¦×œ×—×”`;
      if (skippedCount > 0) {
        message += `\n${skippedCount} ×§×•×•×™× ×“×•×œ×’×• (×›×¤×™×œ×•×™×•×ª ××• ×©×’×™××•×ª)`;
      }
      alert(message);
      
    } catch (error) {
      console.error("×©×’×™××” ×‘×™×™×‘×•× CSV:", error);
      alert(`×©×’×™××” ×‘×™×™×‘×•× ×”×§×•×‘×¥: ${error.message}`);
    }
    
    // ××™×¤×•×¡ ×©×“×” ×”×§×•×‘×¥
    event.target.value = '';
  }

  // ×¤×•× ×§×¦×™×” ×œ× ×™×§×•×™ ×›×œ ×”×§×•×•×™×
  function clearAllLines() {
    if (selectedLines.length === 0) {
      alert("××™×Ÿ ×§×•×•×™× ×œ× ×™×§×•×™");
      return;
    }
    
    if (confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×›×œ ${selectedLines.length} ×”×§×•×•×™×?`)) {
      selectedLines = [];
      updateLinesDisplay();
      clearResults();
    }
  }

  // ×¤×•× ×§×¦×™×” ×œ× ×™×§×•×™ ×ª×•×¦××•×ª
  function clearResults() {
    document.getElementById("results").innerHTML = '';
    allRides = [];
  }
  
  function showLoading(show) {
    const loadingIndicator = document.getElementById('loadingIndicator');
    if (!loadingIndicator) {
      console.error('Loading indicator not found!');
      return;
    }
    
    if (show) {
      loadingIndicator.classList.remove('hidden');
    } else {
      loadingIndicator.classList.add('hidden');
    }
  }

  // ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×”×•×“×¢×ª ×”×”×ª×§×“××•×ª
  function updateProgress(message) {
    const progressText = document.getElementById('progressText');
    if (progressText) {
      progressText.textContent = message;
    }
  }

  // ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ××¤×” (××”×§×•×‘×¥ ×”××§×•×¨×™)
  async function showRideMap(siriRideId, gtfsRouteId) {
    if (!siriRideId) {
      alert("××™×Ÿ × ×ª×•× ×™ ××¡×œ×•×œ ×–××™× ×™× ×œ× ×¡×™×¢×” ×–×•");
      return;
    }
    
    showLoading(true);
    updateProgress("×˜×•×¢×Ÿ × ×ª×•× ×™ ××™×§×•×...");
    
    try {
      // ×™×¦×™×¨×ª ×“×™××œ×•×’ ×œ×”×¦×’×ª ×”××¤×”
      const mapDialog = document.createElement('div');
      mapDialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      mapDialog.setAttribute('data-dialog', 'map');
      mapDialog.innerHTML = `
        <div class="bg-white rounded-xl p-6 max-w-5xl w-full h-4/5 flex flex-col">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">××¤×ª × ×¡×™×¢×”</h2>
            <button id="closeMapBtn" class="text-gray-500 hover:text-gray-800">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          <div id="mapContainer" class="flex-grow bg-gray-100 rounded-lg">
            <div class="w-full h-full flex items-center justify-center">
              <p class="text-blue-600">×˜×•×¢×Ÿ × ×ª×•× ×™ ××™×§×•×...</p>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(mapDialog);
      
      // ×”×’×“×¨×ª ×›×¤×ª×•×¨ ×¡×’×™×¨×”
      document.getElementById('closeMapBtn').addEventListener('click', () => {
        document.body.removeChild(mapDialog);
      });
      
      // ×§×‘×œ×ª × ×ª×•× ×™ ×”××™×§×•× GPS
      const locationData = await fetchLocationData(siriRideId);
      
      if (locationData.length === 0) {
        document.getElementById('mapContainer').innerHTML = '<p class="text-center p-4">×œ× × ××¦××• × ×ª×•× ×™ ××™×§×•× GPS ×œ× ×¡×™×¢×” ×–×•</p>';
        showLoading(false);
        return;
      }
      
      renderLocationMap(locationData);
      
    } catch (error) {
      console.error("×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ××™×§×•×:", error);
      if (document.getElementById('mapContainer')) {
        document.getElementById('mapContainer').innerHTML = `<p class="text-red-600 p-4 text-center">×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ××™×§×•×: ${error.message}</p>`;
      }
    } finally {
      showLoading(false);
    }
  }

  // ×¤×•× ×§×¦×™×” ×œ×§×‘×œ×ª × ×ª×•× ×™ ××™×§×•× (××”×§×•×‘×¥ ×”××§×•×¨×™)
  async function fetchLocationData(siriRideId) {
    try {
      const response = await fetch(`https://open-bus-stride-api.hasadna.org.il/siri_vehicle_locations/list?limit=500&siri_rides__ids=${siriRideId}`);
      
      if (!response.ok) {
        console.error(`×©×’×™××ª ×©×¨×ª ×‘×§×‘×œ×ª × ×ª×•× ×™ ××™×§×•×: ${response.status}`);
        return [];
      }
      
      const data = await response.json();
      
      return data
        .filter(loc => loc.lat && loc.lon)
        .sort((a, b) => new Date(a.recorded_at_time) - new Date(b.recorded_at_time));
        
    } catch (error) {
      console.error("×©×’×™××” ×‘×§×‘×œ×ª × ×ª×•× ×™ ××™×§×•×:", error);
      return [];
    }
  }

  // ×¤×•× ×§×¦×™×” ×œ×¨×™× ×“×•×¨ ××¤×” ×¢× × ×ª×•× ×™ ××™×§×•× GPS (××”×§×•×‘×¥ ×”××§×•×¨×™)
  function renderLocationMap(locationData) {
    if (locationData.length === 0) {
      document.getElementById('mapContainer').innerHTML = '<p class="text-center p-4">×œ× × ××¦××• × ×ª×•× ×™ ××™×§×•× ×œ× ×¡×™×¢×” ×–×•</p>';
      return;
    }
    
    // ×ª×¦×•×’×ª ×”××™×§×•××™× ×‘××¤×”
    const mapContainer = document.getElementById('mapContainer');
    mapContainer.innerHTML = '<div id="map" class="w-full h-full"></div>';
    
    // ×™×¦×™×¨×ª ××¤×” ×‘×××¦×¢×•×ª Leaflet
    const map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    
    // ×”×•×¡×¤×ª ×”× ×§×•×“×•×ª ×œ××¤×”
    const points = locationData.map(loc => [loc.lat, loc.lon]);
      
    // ×™×¦×™×¨×ª ×§×• ×”××—×‘×¨ ××ª ×”× ×§×•×“×•×ª
    const polyline = L.polyline(points, {color: 'blue', weight: 4}).addTo(map);
      
    // ×”×•×¡×¤×ª ×¡××Ÿ ×œ×›×œ × ×§×•×“×ª GPS ×¢× ×¤×•×¤××¤
    locationData.forEach((loc, index) => {
      // ×™×¦×™×¨×ª ×¡××Ÿ ××•×ª×× ××™×©×™×ª ×¢×‘×•×¨ ×›×œ × ×§×•×“×” (×›× ×§×•×“×” ×›×”×”)
      const pointIcon = L.divIcon({
        html: '<div class="bg-gray-800 rounded-full w-2 h-2 border border-white"></div>',
        className: 'custom-point-icon',
        iconSize: [3, 3],
        iconAnchor: [1, 1]
      });
      
      // ×™×¦×™×¨×ª ×¤×•×¤××¤ ×¢× ×”×–××Ÿ ×”××“×•×™×§
      const timestamp = new Date(loc.recorded_at_time).toLocaleString('he-IL');
      const popupContent = `
        <div class="text-right">
          <strong>×–××Ÿ:</strong> ${timestamp}<br>
          <strong>×§×•××•×¨×“×™× ×˜×•×ª:</strong> ${loc.lat.toFixed(6)}, ${loc.lon.toFixed(6)}
        </div>
      `;
      
      // ×”×•×¡×¤×ª ×”×¡××Ÿ ×œ××¤×” ×¢× ×”×¤×•×¤××¤
      L.marker([loc.lat, loc.lon], {icon: pointIcon}).addTo(map)
        .bindPopup(popupContent);
    });
      
    // ×”×•×¡×¤×ª ×¡×× ×™× ×œ×ª×—×™×œ×ª ×•×¡×•×£ ×”××¡×œ×•×œ
    const startIcon = L.divIcon({
      html: '<div class="bg-green-600 rounded-full w-4 h-4 border-2 border-white"></div>',
      className: 'custom-div-icon'
    });
    
    const endIcon = L.divIcon({
      html: '<div class="bg-red-600 rounded-full w-4 h-4 border-2 border-white"></div>',
      className: 'custom-div-icon'
    });
    
    // ×”×•×¡×¤×ª ×¡×™××•×Ÿ ×œ×ª×—×™×œ×ª ×•×¡×•×£ ×”××¡×œ×•×œ
    L.marker(points[0], {icon: startIcon}).addTo(map)
      .bindPopup(`<strong>×ª×—×™×œ×ª ××¡×œ×•×œ</strong><br>${new Date(locationData[0].recorded_at_time).toLocaleString('he-IL')}`);
    
    L.marker(points[points.length - 1], {icon: endIcon}).addTo(map)
      .bindPopup(`<strong>×¡×•×£ ××¡×œ×•×œ</strong><br>${new Date(locationData[locationData.length - 1].recorded_at_time).toLocaleString('he-IL')}`);
    
    // ×”×•×¡×¤×ª ×¡×× ×™× ×œ×›×œ ×ª×—× ×” (×× ×™×© ××™×“×¢ ×¢×œ ×ª×—× ×•×ª)
    locationData.forEach((loc, index) => {
      if (loc.stop_point_ref) {
        const stationIcon = L.divIcon({
          html: '<div class="bg-blue-500 rounded-full w-3 h-3 border border-white"></div>',
          className: 'custom-station-icon'
        });
        
        L.marker([loc.lat, loc.lon], {icon: stationIcon}).addTo(map)
          .bindPopup(`<strong>×ª×—× ×”: ${loc.stop_point_ref}</strong><br>${new Date(loc.recorded_at_time).toLocaleString('he-IL')}`);
      }
    });
    
    // ×”×ª×××ª ×”×ª×¦×•×’×” ×›×š ×©×›×œ ×”× ×§×•×“×•×ª ×™×”×™×• ×’×œ×•×™×•×ª
    map.fitBounds(polyline.getBounds(), { padding: [30, 30] });
  }

  // ===============

  // ===== ××—×œ×§×” ×œ× ×™×”×•×œ ×‘×™×¦×•×¢×™× ×•×—×™×¤×•×© =====
class RidesTableManager {
  constructor() {
    this.filterTimeout = null;
    this.currentSortField = 'scheduled_start_time';
    this.currentSortDirection = 'asc';
  }

  // 1. ×¤×•× ×§×¦×™×” ×××•×¤×˜××ª ×œ×”×¦×’×ª ×ª×•×¦××•×ª ×¢× ×¨×™× ×“×•×¨ ××“×•×¨×’
  async displayResultsChunked() {
    const resultsDiv = document.getElementById("results");
    
    if (allRides.length === 0) {
      resultsDiv.innerHTML = '<p class="text-red-600 text-center">×œ× × ××¦××• × ×¡×™×¢×•×ª ×‘×ª××¨×™×š ×”× ×‘×—×¨ ×¢×‘×•×¨ ×”×§×•×•×™× ×©× ×‘×—×¨×•.</p>';
      return;
    }
    
    // ××–×”×¨×” ×œ××§×¨×™× ×§×™×¦×•× ×™×™×
    if (allRides.length > 10000) {
      const proceed = confirm(`× ××¦××• ${allRides.length} × ×¡×™×¢×•×ª.\n\n×–×” ×¢×œ×•×œ ×œ×’×¨×•× ×œ×‘×™×¦×•×¢×™× ××™×˜×™×™× ×××•×“.\n×”×× ×œ×”××©×™×š?\n\n(××•××œ×¥ ×œ×¡× ×Ÿ ×œ×¤×—×•×ª ×§×•×•×™× ××• ×ª××¨×™×›×™×)`);
      if (!proceed) return;
    }
    
    // ×œ× × ×¤×ª×— ×¤×•×¤××¤ ×—×“×© ×›××Ÿ - × ××©×™×š ×¢× ×”×§×™×™×
    updateProgress("××›×™×Ÿ ××ª ×”×˜×‘×œ×”...");
    
    // ×™×¦×™×¨×ª ×”××‘× ×” ×”×‘×¡×™×¡×™
    const searchAndControlsHTML = this.createSearchControls();
    const tableHeaderHTML = this.createTableHeader();
    
    resultsDiv.innerHTML = searchAndControlsHTML + `
      <div class="overflow-x-auto">
        <table id="ridesTable" class="w-full table-auto border border-collapse">
          ${tableHeaderHTML}
          <tbody id="ridesTableBody">
            <!-- ×©×•×¨×•×ª ×™×ª×•×•×¡×¤×• ×‘×”×“×¨×’×” -->
          </tbody>
        </table>
      </div>
      <div id="loadingRows" class="text-center p-4 text-blue-600">
        ×˜×•×¢×Ÿ × ×ª×•× ×™×...
      </div>
    `;
    
    // ×¨×™× ×“×•×¨ ×‘×—×œ×§×™× ×§×˜× ×™× ×›×“×™ ×œ× ×œ×—×¡×•× ××ª ×”×“×¤×“×¤×Ÿ
    await this.renderTableInChunks();
    // *** ×¡×’×™×¨×ª ×”×¤×•×¤××¤ ×¨×§ ×›××Ÿ - ××—×¨×™ ×’××¨ ×”×¨×™× ×“×•×¨ ×”××œ× ***
    showLoading(false);
  }

  // 2. ×¨×™× ×“×•×¨ ××“×•×¨×’
  async renderTableInChunks() {
    const tbody = document.getElementById('ridesTableBody');
    const loadingIndicator = document.getElementById('loadingRows');
    const chunkSize = 100; // 100 ×©×•×¨×•×ª ×‘×›×œ ×¤×¢×
    let currentIndex = 0;
    
    const renderChunk = () => {
      return new Promise((resolve) => {
        const endIndex = Math.min(currentIndex + chunkSize, allRides.length);
        const chunk = allRides.slice(currentIndex, endIndex);
        
        // ×™×¦×™×¨×ª HTML ×¢×‘×•×¨ ×”×—×œ×§ ×”× ×•×›×—×™
        const chunkHTML = chunk.map((ride, index) => {
          const globalIndex = currentIndex + index;
          return this.createTableRow(ride, globalIndex);
        }).join('');
        
        // ×”×•×¡×¤×” ×œ×˜×‘×œ×”
        tbody.insertAdjacentHTML('beforeend', chunkHTML);
        
        currentIndex = endIndex;
        updateProgress(`× ×˜×¢× ×• ${currentIndex} ××ª×•×š ${allRides.length} × ×¡×™×¢×•×ª...`);
        
        // ×× ×™×© ×¢×•×“ - ×ª××©×™×š ××—×¨×™ delay ×§×¦×¨
        if (currentIndex < allRides.length) {
          setTimeout(() => {
            renderChunk().then(resolve);
          }, 5); // 5ms delay ×›×“×™ ×œ×ª×ª ×œ×“×¤×“×¤×Ÿ ×œ× ×©×•×
        } else {
          // ×¡×™×•× - ×¤×•×¤××¤ ×™×•×¡×¨ ×‘×¤×•× ×§×¦×™×” ×”×§×•×¨××ª
          if (loadingIndicator) loadingIndicator.remove();
          console.log(`×¡×™×•× ×¨×™× ×“×•×¨ ${allRides.length} ×©×•×¨×•×ª`);
          resolve();
        }
      });
    };
    
    await renderChunk();
  }

  // 3. ×™×¦×™×¨×ª ×©×•×¨×ª ×˜×‘×œ×” ×××•×¤×˜××ª
  createTableRow(ride, index) {
    const rideDate = new Date(ride.scheduled_start_time);
    
    const isNewVehicleGroup = index > 0 && 
      ride.vehicle_ref && 
      allRides[index - 1].vehicle_ref && 
      ride.vehicle_ref !== allRides[index - 1].vehicle_ref;
    
    const rowClass = isNewVehicleGroup ? 'hover:bg-gray-50 vehicle-group-border' : 'hover:bg-gray-50';
    
    // HTML ××™× ×™××œ×™ ×œ×‘×™×¦×•×¢×™× - ×”×•×¡×¤×ª route_mkt ×•-line_ref ×œ×©×“×•×ª data
    return `<tr class="${rowClass}" 
               data-vehicle="${ride.vehicle_ref || ''}" 
               data-line="${ride.line_number}" 
               data-operator="${ride.operator_name}" 
               data-route-mkt="${ride.route_mkt || ''}" 
               data-line-ref="${ride.siri_route__line_ref || ''}">
      <td class="border p-2">${rideDate.toLocaleDateString('he-IL')} ${rideDate.toLocaleTimeString('he-IL')}</td>
      <td class="border p-2 font-bold">${ride.line_number}</td>
      <td class="border p-2">${ride.operator_name}</td>
      <td class="border p-2 font-mono vehicle-ref">${ride.vehicle_ref || '×œ× ×–××™×Ÿ'}</td>
      <td class="border p-2">${ride.siri_route__line_ref}</td>
      <td class="border p-2">${ride.route_dest?.from || ""}</td>
      <td class="border p-2">${ride.route_dest?.to || ""}</td>
      <td class="border p-2">${ride.route_dest?.alternative || ""}</td>
      <td class="border p-2">${ride.id ? `<button onclick="showRideMap('${ride.id}', '')" class="bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700 transition">×¦×¤×” ×‘××¤×”</button>` : '××™×Ÿ × ×ª×•× ×™×'}</td>
    </tr>`;
  }

  // 4. ×™×¦×™×¨×ª controls
  createSearchControls() {
    return `
      <div class="mb-6 space-y-4">
        <div class="p-3 bg-green-50 rounded-lg">
          <p class="text-green-700 font-bold">× ××¦××• ${allRides.length} × ×¡×™×¢×•×ª ×‘×ª××¨×™×š ${document.getElementById("selectedDate").value}</p>
          <p class="text-gray-600">×¢×‘×•×¨ ${selectedLines.length} ×§×•×•×™×</p>
        </div>
        
        <div class="bg-blue-50 p-4 rounded-lg space-y-3">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div>
              <label class="block font-medium mb-1">×—×™×¤×•×© ××¡×¤×¨ ×¨×™×©×•×™:</label>
              <input type="text" id="vehicleSearch" placeholder="×”×§×œ×“ ××¡×¤×¨ ×¨×™×©×•×™..." 
                     class="w-full p-2 border rounded-lg" 
                     oninput="ridesManager.debounceFilter('vehicle', this.value)">
            </div>
            <div>
              <label class="block font-medium mb-1">×‘×—×¨ ×§×• ××”×¨×©×™××”:</label>
              <div class="relative">
                <input type="text" id="lineSearch" placeholder="×”×§×œ×“ ××¡×¤×¨ ×§×• ××• ×©× ×¢×™×¨..." 
                      class="w-full p-2 border rounded-lg" 
                      oninput="ridesManager.showLineDropdown(this.value)"
                      onfocus="ridesManager.showLineDropdown(this.value)"
                      onblur="setTimeout(() => ridesManager.hideLineDropdown(), 200)">
                <div id="lineDropdown" class="hidden absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg max-h-40 overflow-y-auto z-10">
                  <!-- ××¤×©×¨×•×™×•×ª ×™×ª×•×•×¡×¤×• ×›××Ÿ -->
                </div>
              </div>
            </div>
            <div>
              <label class="block font-medium mb-1">×—×™×¤×•×© ××¤×¢×™×œ:</label>
              <input type="text" id="operatorSearch" placeholder="×”×§×œ×“ ×©× ××¤×¢×™×œ..." 
                     class="w-full p-2 border rounded-lg" 
                     oninput="ridesManager.debounceFilter('operator', this.value)">
            </div>
          </div>
          
          <div class="flex gap-2 flex-wrap">
            <button onclick="ridesManager.clearAllFilters()" class="bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600">
              × ×§×” ×¡×™× ×•× ×™×
            </button>
            <button onclick="ridesManager.exportToCSV()" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">
              ğŸ“„ ×™×™×¦× ×œ-CSV
            </button>
            <button onclick="ridesManager.groupByVehicleOptimized()" class="bg-purple-600 text-white px-3 py-1 rounded hover:bg-purple-700">
              ğŸ“Š ×§×‘×¥ ×œ×¤×™ ×¨×›×‘
            </button>
          </div>
        </div>
        
        <div id="filterInfo" class="hidden p-2 bg-yellow-50 rounded border border-yellow-200">
          <span id="filterInfoText"></span>
        </div>
      </div>
    `;
  }

  // 5. ×™×¦×™×¨×ª header
  createTableHeader() {
    return `
      <thead class="bg-gray-100 sticky top-0">
        <tr>
          <th class="border p-2 sortable" onclick="ridesManager.sortTableOptimized('scheduled_start_time')">
            ×ª××¨×™×š ×•×©×¢×ª ×™×¦×™××” <span class="sort-indicator">${getSortIndicator('scheduled_start_time')}</span>
          </th>
          <th class="border p-2 sortable" onclick="ridesManager.sortTableOptimized('line_number')">
            ××¡×¤×¨ ×§×• <span class="sort-indicator">${getSortIndicator('line_number')}</span>
          </th>
          <th class="border p-2 sortable" onclick="ridesManager.sortTableOptimized('operator_name')">
            ×—×‘×¨×” ××¤×¢×™×œ×” <span class="sort-indicator">${getSortIndicator('operator_name')}</span>
          </th>
          <th class="border p-2 sortable" onclick="ridesManager.sortTableOptimized('vehicle_ref')">
            ××¡×¤×¨ ×¨×™×©×•×™ <span class="sort-indicator">${getSortIndicator('vehicle_ref')}</span>
          </th>
          <th class="border p-2">line_ref</th>
          <th class="border p-2">××•×¦×</th>
          <th class="border p-2">×™×¢×“</th>
          <th class="border p-2">×—×œ×•×¤×”</th>
          <th class="border p-2">××¤×ª × ×¡×™×¢×”</th>
        </tr>
      </thead>
    `;
  }

  // 6. ×¡×™× ×•×Ÿ ×¢× debouncing
  debounceFilter(type, value) {
    clearTimeout(this.filterTimeout);
    this.filterTimeout = setTimeout(() => {
      switch(type) {
        case 'vehicle': this.filterByVehicle(value); break;
        case 'line': this.filterByLine(value); break;
        case 'operator': this.filterByOperator(value); break;
      }
    }, 200); // 200ms ××—×¨×™ ×©×”××©×ª××© ××¤×¡×™×§ ×œ×”×§×œ×™×“
  }

  // 7. ×¤×•× ×§×¦×™×•×ª ×¡×™× ×•×Ÿ ×××•×¤×˜××•×ª
  filterByVehicle(vehicleNumber) {
    const filterInfo = document.getElementById('filterInfo');
    const filterInfoText = document.getElementById('filterInfoText');
    
    if (!vehicleNumber.trim()) {
      this.showAllRows();
      filterInfo.classList.add('hidden');
      return;
    }
    
    const rows = document.querySelectorAll('#ridesTableBody tr');
    let visibleCount = 0;
    
    // ×‘×¦×¢ ×¡×™× ×•×Ÿ ×‘×—×œ×§×™× ×§×˜× ×™× ×œ××§×¨×™× ×§×™×¦×•× ×™×™×
    this.processBatchFilter(rows, (row) => {
      const vehicleRef = row.getAttribute('data-vehicle');
      const shouldShow = vehicleRef && vehicleRef.includes(vehicleNumber);
      if (shouldShow) visibleCount++;
      return shouldShow;
    }, () => {
      filterInfo.classList.remove('hidden');
      filterInfoText.textContent = `××•×¦×’×•×ª ${visibleCount} × ×¡×™×¢×•×ª ×”××›×™×œ×•×ª "${vehicleNumber}" ×‘××¡×¤×¨ ×”×¨×™×©×•×™`;
    });
  }

  // *** ×”×ª×™×§×•×Ÿ ×œ×—×™×¤×•×© ××“×•×™×§ ××¡×¤×¨ ×§×• ***
  filterByLine(lineNumber) {
    const filterInfo = document.getElementById('filterInfo');
    const filterInfoText = document.getElementById('filterInfoText');
    
    if (!lineNumber.trim()) {
      this.showAllRows();
      filterInfo.classList.add('hidden');
      return;
    }
    
    const rows = document.querySelectorAll('#ridesTableBody tr');
    let visibleCount = 0;
    
    this.processBatchFilter(rows, (row) => {
      const lineRef = row.getAttribute('data-line');
      // *** ×—×™×¤×•×© ××“×•×™×§ - ×”×©×•×•××” ××œ××” ×‘××§×•× includes ***
      const shouldShow = lineRef && lineRef === lineNumber;
      if (shouldShow) visibleCount++;
      return shouldShow;
    }, () => {
      filterInfo.classList.remove('hidden');
      filterInfoText.textContent = `××•×¦×’×•×ª ${visibleCount} × ×¡×™×¢×•×ª ×©×œ ×§×• ${lineNumber}`;
    });
  }

  filterByOperator(operatorName) {
    const filterInfo = document.getElementById('filterInfo');
    const filterInfoText = document.getElementById('filterInfoText');
    
    if (!operatorName.trim()) {
      this.showAllRows();
      filterInfo.classList.add('hidden');
      return;
    }
    
    const rows = document.querySelectorAll('#ridesTableBody tr');
    let visibleCount = 0;
    
    this.processBatchFilter(rows, (row) => {
      const operator = row.getAttribute('data-operator');
      const shouldShow = operator && operator.includes(operatorName);
      if (shouldShow) visibleCount++;
      return shouldShow;
    }, () => {
      filterInfo.classList.remove('hidden');
      filterInfoText.textContent = `××•×¦×’×•×ª ${visibleCount} × ×¡×™×¢×•×ª ×©×œ ××¤×¢×™×œ×™× ×”××›×™×œ×™× "${operatorName}"`;
    });
  }

  // 8. ×¢×™×‘×•×“ ×¡×™× ×•×Ÿ ×‘×—×œ×§×™×
  processBatchFilter(rows, filterFunc, callback) {
    let currentIndex = 0;
    const batchSize = 200;
    
    const processBatch = () => {
      const endIndex = Math.min(currentIndex + batchSize, rows.length);
      
      for (let i = currentIndex; i < endIndex; i++) {
        const row = rows[i];
        const shouldShow = filterFunc(row);
        row.style.display = shouldShow ? '' : 'none';
      }
      
      currentIndex = endIndex;
      
      if (currentIndex < rows.length) {
        setTimeout(processBatch, 1); // 1ms delay
      } else {
        callback();
      }
    };
    
    processBatch();
  }

  // 9. ×”×¦×’×ª ×›×œ ×”×©×•×¨×•×ª
  showAllRows() {
    const rows = document.querySelectorAll('#ridesTableBody tr');
    rows.forEach(row => row.style.display = '');
  }

  // 10. × ×™×§×•×™ ×¡×™× ×•× ×™×
  clearAllFilters() {
    document.getElementById('vehicleSearch').value = '';
    document.getElementById('lineSearch').value = '';
    document.getElementById('operatorSearch').value = '';
    this.hideLineDropdown(); // ×”×•×¡×¤×”
    this.showAllRows();
    document.getElementById('filterInfo').classList.add('hidden');
  }

  // 11. ××™×•×Ÿ ×××•×¤×˜×
  async sortTableOptimized(field) {
    if (currentSortField === field) {
      currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
      currentSortField = field;
      currentSortDirection = 'asc';
    }
    
    // *** ×©××™×¨×ª ×”×¡×™× ×•× ×™× ×”× ×•×›×—×™×™× - ×›×•×œ×œ ×–×™×”×•×™ ×× ×–×” ×§×• ×¡×¤×¦×™×¤×™ ***
    const currentFilters = {
      vehicle: document.getElementById('vehicleSearch')?.value || '',
      line: document.getElementById('lineSearch')?.value || '',
      operator: document.getElementById('operatorSearch')?.value || '',
      isSpecificLine: false,
      selectedLine: null
    };
    
    // *** ×–×™×”×•×™ ×× ×”×¡×™× ×•×Ÿ ×”× ×•×›×—×™ ×”×•× ×©×œ ×§×• ×¡×¤×¦×™×¤×™ ***
    if (currentFilters.line) {
      // ×—×™×¤×•×© ×× ×™×© ×§×• ×©×”-displayName ×©×œ×• ×ª×•×× ×œ×¢×¨×š ×‘×©×“×” ×”×—×™×¤×•×©
      const matchingLine = selectedLines.find(line => {
        const displayName = line.displayName || `×§×• ${line.routeNumber}`;
        return displayName === currentFilters.line;
      });
      
      if (matchingLine) {
        currentFilters.isSpecificLine = true;
        currentFilters.selectedLine = matchingLine;
      }
    }
    
    showLoading(true);
    updateProgress("×××™×™×Ÿ × ×ª×•× ×™×...");
    
    // ××™×•×Ÿ ×”× ×ª×•× ×™×
    await new Promise(resolve => {
      setTimeout(() => {
        allRides.sort((a, b) => {
          let aVal = a[field];
          let bVal = b[field];
          
          if (!aVal && !bVal) return 0;
          if (!aVal) return 1;
          if (!bVal) return -1;
          
          if (field === 'vehicle_ref') {
            if (aVal !== bVal) {
              const comparison = aVal.localeCompare(bVal);
              return currentSortDirection === 'asc' ? comparison : -comparison;
            }
            const aTime = new Date(a.scheduled_start_time);
            const bTime = new Date(b.scheduled_start_time);
            return currentSortDirection === 'asc' ? aTime - bTime : bTime - aTime;
          }
          
          if (field === 'scheduled_start_time') {
            aVal = new Date(aVal);
            bVal = new Date(bVal);
          }
          
          if (field === 'line_number') {
            aVal = parseInt(aVal) || 0;
            bVal = parseInt(bVal) || 0;
          }
          
          if (aVal < bVal) return currentSortDirection === 'asc' ? -1 : 1;
          if (aVal > bVal) return currentSortDirection === 'asc' ? 1 : -1;
          return 0;
        });
        resolve();
      }, 50);
    });
    
    // ×¨×™× ×“×•×¨ ××—×“×©
    await this.displayResultsChunked();
    
    // *** ×”×—×–×¨×ª ×”×¡×™× ×•× ×™× ××—×¨×™ ×”×¨×™× ×“×•×¨ - ×¢× ×˜×™×¤×•×œ × ×›×•×Ÿ ×‘×§×•×•×™× ×¡×¤×¦×™×¤×™×™× ***
    setTimeout(() => {
      if (currentFilters.vehicle) {
        document.getElementById('vehicleSearch').value = currentFilters.vehicle;
        this.debounceFilter('vehicle', currentFilters.vehicle);
      }
      
      if (currentFilters.line) {
        document.getElementById('lineSearch').value = currentFilters.line;
        
        if (currentFilters.isSpecificLine && currentFilters.selectedLine) {
          // *** ×× ×–×” ×§×• ×¡×¤×¦×™×¤×™ - ×”×©×ª××© ×‘×¡×™× ×•×Ÿ ×”×¡×¤×¦×™×¤×™ ***
          this.filterBySpecificLine(currentFilters.selectedLine);
        } else {
          // *** ×× ×–×” ×—×™×¤×•×© ×›×œ×œ×™ - ×”×©×ª××© ×‘×¡×™× ×•×Ÿ ×”×›×œ×œ×™ ***
          this.debounceFilter('line', currentFilters.line);
        }
      }
      
      if (currentFilters.operator) {
        document.getElementById('operatorSearch').value = currentFilters.operator;
        this.debounceFilter('operator', currentFilters.operator);
      }
    }, 100);
  }

  // 12. ×§×™×‘×•×¥ ×××•×¤×˜× ×œ×¤×™ ×¨×›×‘
  async groupByVehicleOptimized() {
    showLoading(true);
    updateProgress("××§×‘×¥ × ×ª×•× ×™× ×œ×¤×™ ×¨×›×‘...");
    
    await new Promise(resolve => {
      setTimeout(() => {
        const vehicleGroups = new Map();
        
        allRides.forEach(ride => {
          const vehicleRef = ride.vehicle_ref || '×œ× ×–××™×Ÿ';
          if (!vehicleGroups.has(vehicleRef)) {
            vehicleGroups.set(vehicleRef, []);
          }
          vehicleGroups.get(vehicleRef).push(ride);
        });
        
        // ××™×•×Ÿ ××¡×¤×¨×™
        function naturalSort(a, b) {
          const aKey = a[0];
          const bKey = b[0];
          
          if (aKey === '×œ× ×–××™×Ÿ') return 1;
          if (bKey === '×œ× ×–××™×Ÿ') return -1;
          
          return aKey.localeCompare(bKey, undefined, {
            numeric: true,
            sensitivity: 'base'
          });
        }
        
        const sortedGroups = Array.from(vehicleGroups.entries()).sort(naturalSort);
        
        let groupHTML = `
          <div class="space-y-4">
            <h3 class="text-xl font-bold">×§×™×‘×•×¥ ×œ×¤×™ ×¨×›×‘ (${sortedGroups.length} ×¨×›×‘×™×)</h3>
            <button onclick="ridesManager.displayResultsChunked()" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
              â† ×—×–×¨×” ×œ×ª×¦×•×’×” ×¨×’×™×œ×”
            </button>
        `;
        
        sortedGroups.forEach(([vehicleRef, rides]) => {
          const firstRide = rides[0];
          const lastRide = rides[rides.length - 1];
          const firstTime = new Date(firstRide.scheduled_start_time).toLocaleTimeString('he-IL');
          const lastTime = new Date(lastRide.scheduled_start_time).toLocaleTimeString('he-IL');
          
          groupHTML += `
            <div class="border rounded-lg p-4 bg-white">
              <div class="flex justify-between items-center mb-2">
                <h4 class="font-bold text-lg">×¨×›×‘ ${vehicleRef}</h4>
                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">${rides.length} × ×¡×™×¢×•×ª</span>
              </div>
              <p class="text-gray-600 mb-2">
                ×-${firstTime} ×¢×“ ${lastTime} | 
                ×§×•×•×™×: ${[...new Set(rides.map(r => r.line_number))].join(', ')}
              </p>
              <button onclick="ridesManager.showVehicleDetails('${vehicleRef}')" 
                      class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">
                ×”×¦×’ ×¤×™×¨×•×˜
              </button>
            </div>
          `;
        });
        
        groupHTML += '</div>';
        document.getElementById("results").innerHTML = groupHTML;
        resolve();
      }, 50);
    });
    
    showLoading(false);
  }

  // 13. ×”×¦×’×ª ×¤×¨×˜×™ ×¨×›×‘
  async showVehicleDetails(vehicleRef) {
    await this.displayResultsChunked();
    document.getElementById('vehicleSearch').value = vehicleRef;
    this.debounceFilter('vehicle', vehicleRef);
  }

  // 14. ×™×™×¦×•× ×œ-CSV
  exportToCSV() {
    if (allRides.length === 0) {
      alert("××™×Ÿ × ×ª×•× ×™× ×œ×™×™×¦×•×");
      return;
    }
    
    const headers = ['×ª××¨×™×š ×•×©×¢×”', '××¡×¤×¨ ×§×•', '×—×‘×¨×”', '××¡×¤×¨ ×¨×™×©×•×™', 'line_ref', '××•×¦×', '×™×¢×“', '×—×œ×•×¤×”'];
    const csvContent = [
      headers.join(','),
      ...allRides.map(ride => {
        const rideDate = new Date(ride.scheduled_start_time);
        return [
          `"${rideDate.toLocaleDateString('he-IL')} ${rideDate.toLocaleTimeString('he-IL')}"`,
          ride.line_number,
          `"${ride.operator_name}"`,
          `"${ride.vehicle_ref || '×œ× ×–××™×Ÿ'}"`,
          ride.siri_route__line_ref,
          `"${ride.route_dest?.from || ""}"`,
          `"${ride.route_dest?.to || ""}"`,
          `"${ride.route_dest?.alternative || ""}"`
        ].join(',');
      })
    ].join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `rides_${document.getElementById("selectedDate").value}.csv`;
    link.click();
  }

  // 15. ×”×¦×’×ª ×“×¨×•×¤×“××•×Ÿ ×§×•×•×™× ×—×›×
  showLineDropdown(searchValue) {
    const dropdown = document.getElementById('lineDropdown');
    if (!dropdown) return;
    
    // ×§×‘×œ×ª ×¨×©×™××ª ×§×•×•×™× ×™×™×—×•×“×™×™× ×œ×¤×™ routeMkt (×œ× routeNumber!)
    const uniqueLines = new Map();
    selectedLines.forEach(line => {
      // *** ×”×©×ª××© ×‘-routeMkt ××• ×‘×©×™×œ×•×‘ ×©×œ operatorRef+routeNumber ×›××¤×ª×— ***
      const key = line.routeMkt || `${line.operatorRef}_${line.routeNumber}`;
      const display = line.displayName || `×§×• ${line.routeNumber}`;
      
      uniqueLines.set(key, {
        routeMkt: line.routeMkt,
        number: line.routeNumber,
        display: display,
        operator: line.operatorName,
        operatorRef: line.operatorRef
      });
    });
    
    // ×¡×™× ×•×Ÿ ×œ×¤×™ ×”×˜×§×¡×˜ ×©×”×•×§×œ×“
    const filteredLines = Array.from(uniqueLines.values()).filter(line => {
      if (!searchValue.trim()) return true;
      
      const searchLower = searchValue.toLowerCase();
      return (
        line.number.toString().includes(searchValue) ||
        line.display.toLowerCase().includes(searchLower) ||
        line.operator.toLowerCase().includes(searchLower)
      );
    });
    
    if (filteredLines.length === 0) {
      dropdown.classList.add('hidden');
      return;
    }
    
    // *** ××™×•×Ÿ ×”×§×•×•×™× ×œ×¤×™ ××¡×¤×¨ ×§×• (××™×•×Ÿ ××¡×¤×¨×™) ***
    filteredLines.sort((a, b) => {
      const aNum = parseInt(a.number) || 0;
      const bNum = parseInt(b.number) || 0;
      return aNum - bNum;
    });
    
    // ×™×¦×™×¨×ª ××¤×©×¨×•×™×•×ª
    const optionsHTML = filteredLines.map(line => `
      <div class="p-2 hover:bg-blue-50 cursor-pointer border-b last:border-b-0" 
          onclick="ridesManager.selectLineFromDropdown('${line.routeMkt || ''}', '${line.operatorRef}', '${line.number}', '${line.display}')">
        <div class="font-bold">${line.display}</div>
        <div class="text-sm text-gray-600">${line.operator}</div>
      </div>
    `).join('');
    
    dropdown.innerHTML = optionsHTML || '<div class="p-2 text-gray-500">×œ× × ××¦××• ×§×•×•×™×</div>';
    dropdown.classList.remove('hidden');
  }

  // 16. ×‘×—×™×¨×ª ×§×• ××”×“×¨×•×¤×“××•×Ÿ
  selectLineFromDropdown(routeMkt, operatorRef, routeNumber, displayName) {
    const lineSearchInput = document.getElementById('lineSearch');
    lineSearchInput.value = displayName;
    
    // *** ××¦×™××ª ×”×§×• ×”× ×›×•×Ÿ ×œ×¤×™ routeMkt ***
    const selectedLine = selectedLines.find(line => {
      if (routeMkt) {
        return line.routeMkt === routeMkt;
      } else {
        // fallback ×œ××§×¨×” ×©×œ ×§×•×•×™× ×™×©× ×™× ×œ×œ× routeMkt
        return line.operatorRef === operatorRef && line.routeNumber === routeNumber;
      }
    });
    
    if (selectedLine) {
      // *** ×”×¤×¢×œ×ª ×”×¡×™× ×•×Ÿ ×œ×¤×™ ×”×§×• ×”×¡×¤×¦×™×¤×™ (×œ×¤×™ routeMkt) ***
      this.filterBySpecificLine(selectedLine);
    }
    
    // ×”×¡×ª×¨×ª ×”×“×¨×•×¤×“××•×Ÿ
    this.hideLineDropdown();
  }

  // 17. ×”×¡×ª×¨×ª ×“×¨×•×¤×“××•×Ÿ
  hideLineDropdown() {
    const dropdown = document.getElementById('lineDropdown');
    if (dropdown) {
      dropdown.classList.add('hidden');
    }
  }

  // 18. ×¢×“×›×•×Ÿ ×¤×•× ×§×¦×™×™×ª ×”×¡×™× ×•×Ÿ ×œ×§×•×•×™× (×œ×˜×§×¡×˜ ×—×•×¤×©×™)
  filterByLine(lineNumber) {
    const filterInfo = document.getElementById('filterInfo');
    const filterInfoText = document.getElementById('filterInfoText');
    
    if (!lineNumber.trim()) {
      this.showAllRows();
      filterInfo.classList.add('hidden');
      this.hideLineDropdown();
      return;
    }
    
    // ×× ×–×” ××¡×¤×¨ - ×—×¤×© ××“×•×™×§, ×× ×–×” ×˜×§×¡×˜ - ×—×¤×© ×—×œ×§×™ ×‘×ª×¦×•×’×”
    const isNumeric = /^\d+$/.test(lineNumber.trim());
    
    const rows = document.querySelectorAll('#ridesTableBody tr');
    let visibleCount = 0;
    
    this.processBatchFilter(rows, (row) => {
      const lineRef = row.getAttribute('data-line');
      
      if (isNumeric) {
        // ×—×™×¤×•×© ××“×•×™×§ ×œ××¡×¤×¨
        const shouldShow = lineRef && lineRef === lineNumber;
        if (shouldShow) visibleCount++;
        return shouldShow;
      } else {
        // ×—×™×¤×•×© ×—×œ×§×™ ×œ×˜×§×¡×˜ (×©× ×¢×™×¨ ×•×›×•')
        const rideData = allRides.find(ride => ride.line_number === lineRef);
        if (rideData) {
          const matchesLine = lineRef.includes(lineNumber);
          const matchesOperator = rideData.operator_name?.toLowerCase().includes(lineNumber.toLowerCase());
          const matchesRoute = rideData.route_dest?.from?.toLowerCase().includes(lineNumber.toLowerCase()) ||
                              rideData.route_dest?.to?.toLowerCase().includes(lineNumber.toLowerCase());
          
          const shouldShow = matchesLine || matchesOperator || matchesRoute;
          if (shouldShow) visibleCount++;
          return shouldShow;
        }
        return false;
      }
    }, () => {
      filterInfo.classList.remove('hidden');
      filterInfoText.textContent = `××•×¦×’×•×ª ${visibleCount} × ×¡×™×¢×•×ª ×”××›×™×œ×•×ª "${lineNumber}"`;
    });
  }

  // 19. ×¡×™× ×•×Ÿ ×œ×¤×™ ×§×• ×¡×¤×¦×™×¤×™ (×œ×¤×™ routeMkt)
  filterBySpecificLine(selectedLine) {
    const filterInfo = document.getElementById('filterInfo');
    const filterInfoText = document.getElementById('filterInfoText');
    
    const rows = document.querySelectorAll('#ridesTableBody tr');
    let visibleCount = 0;
    
    this.processBatchFilter(rows, (row) => {
      // *** ×—×™×¤×•×© ×œ×¤×™ route_mkt ×× ×§×™×™×, ××—×¨×ª ×œ×¤×™ ×©×™×œ×•×‘ operator_ref + route_number ***
      const routeMkt = row.getAttribute('data-route-mkt');
      const lineRef = row.getAttribute('data-line');
      const operator = row.getAttribute('data-operator');
      
      let shouldShow = false;
      
      if (selectedLine.routeMkt && routeMkt) {
        // ×”×©×•×•××” ××“×•×™×§×ª ×œ×¤×™ route_mkt
        shouldShow = routeMkt === selectedLine.routeMkt;
      } else {
        // fallback - ×”×©×•×•××” ×œ×¤×™ ××¡×¤×¨ ×§×• ×•××¤×¢×™×œ
        shouldShow = lineRef === selectedLine.routeNumber && 
                    operator === selectedLine.operatorName;
      }
      
      if (shouldShow) visibleCount++;
      return shouldShow;
    }, () => {
      filterInfo.classList.remove('hidden');
      const displayName = selectedLine.displayName || `×§×• ${selectedLine.routeNumber}`;
      filterInfoText.textContent = `××•×¦×’×•×ª ${visibleCount} × ×¡×™×¢×•×ª ×©×œ ${displayName}`;
    });
  }
}

// ×™×¦×™×¨×ª instance ×’×œ×•×‘×œ×™
const ridesManager = new RidesTableManager();

  // ===============

  // ×”×—×œ×¤×ª ×”×¤×•× ×§×¦×™×” ×”×§×™×™××ª
  function displayResults() {
    ridesManager.displayResultsChunked();
  }
</script>
</body>
</html>